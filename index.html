<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lập và theo dõi Kế hoạch AT-CL-MT</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0; background-color: #f4f4f9; line-height: 1.6;
        }
        #container {
            max-width: 1400px; margin: auto; background-color: white;
            padding: 25px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: block;
        }
        #login-container {
            max-width: 400px; margin: 100px auto; padding: 30px; background-color: white;
            border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); text-align: center;
            display: none;
        }
        #login-container h2 { margin-top: 0; color: #333; }
        #login-container input {
            width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ccc;
            border-radius: 4px; box-sizing: border-box; font-size: 16px;
        }
        #login-container button { width: 100%; padding: 12px; font-size: 16px; }
        #login-error { color: #dc3545; margin-top: 15px; font-weight: bold; }

        h1, h2 { color: #333; }
        h3 { color: #555; font-weight: normal; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .button-group {
            display: flex; justify-content: space-between; align-items: center;
            margin-top: 10px; flex-wrap: wrap;
        }
        .button-group > div { display: flex; gap: 10px; flex-wrap: wrap; }
        button {
            border: none; padding: 10px 18px; border-radius: 5px;
            cursor: pointer; font-size: 16px; transition: background-color: 0.3s, transform: 0.1s;
        }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        button:active { transform: scale(0.98); }
        .btn-primary { background-color: #007bff; color: white; }
        .btn-primary:hover { background-color: #0056b3; }
        .btn-danger { background-color: #dc3545; color: white; }
        .btn-danger:hover { background-color: #c82333; }
        .btn-secondary { background-color: #6c757d; color: white; }
        .btn-secondary:hover { background-color: #5a6268; }
        .btn-success { background-color: #28a745; color: white; }
        .btn-success:hover { background-color: #218838; }
        .btn-info { background-color: #17a2b8; color: white; }
        .btn-info:hover { background-color: #138496; }
        .btn-warning { background-color: #ffc107; color: #212529; }
        .btn-warning:hover { background-color: #e0a800; }
        .btn-action { padding: 5px 10px; font-size: 14px; margin-right: 5px;}

        input[type="file"] { border: 1px solid #ccc; padding: 8px; border-radius: 4px; }
        #taskList { margin-top: 20px; border-collapse: collapse; width: 100%; table-layout: fixed; }
        #taskList th, #taskList td {
            border: 1px solid #ddd; padding: 10px; text-align: left;
            vertical-align: middle; word-wrap: break-word;
            font-size: 80%;
        }
        #taskList th:first-child, #taskList td:first-child,
        #taskList th:nth-child(2), #taskList td:nth-child(2) {
             padding-left: 4px;
             text-align: left;
        }

        #taskList .btn-action { font-size: 14px; }
        #taskList th {
            background-color: #f2f2f2;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .task-parent td { font-weight: bold; background-color: #e2e6ea; }
        .task-child td { font-weight: bold; background-color: #e9ecef; }
        .task-grandchild td { font-weight: bold; background-color: #f2f4f6; }
        .task-great-grandchild.is-parent-leaf td { background-color: #f8f9fa; }
        .task-great-great-grandchild td:nth-child(3) { font-style: italic; padding-left: 18px !important; }
        .task-justification { display: none; }
        .task-justification td { background-color: #fffbe6; color: red; }
        .task-justification td:nth-child(3) { padding-left: 30px !important; font-style: italic; }
	    .task-justification td:nth-child(2) { padding-left: 25px !important; font-style: italic; }
        .task-justification td.col-tt {
            text-align: right;
            padding-right: 1px;
        }

        #taskList th.text-right, #taskList td.text-right { text-align: right; padding-right: 4px; }
        #taskList th.col-donvi, #taskList td.col-donvi,
        #taskList th.col-soluong, #taskList td.col-soluong {
            text-align: center;
        }

        #status { margin-top: 15px; font-weight: bold; }
        #status.success { color: #28a745; }
        #status.error { color: #dc3545; }

        #summarySection {
            background-color: #e9ecef; padding: 15px; border-radius: 5px; margin-top: 20px;
            display: flex; justify-content: space-between; flex-wrap: wrap;
            position: relative;
        }
        .summary-column { width: 48%; }
        #summarySection p { margin: 5px 0; font-size: 16px; }
        #summarySection p strong { color: #333; }
        .percentage { color: #007bff; font-weight: bold; }

        .modal {
            display: none; position: fixed; z-index: 1000; left: 0; top: 0;
            width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s;
        }
        @keyframes fadeIn { from {opacity: 0;} to {opacity: 1;} }
        .modal-content {
            background-color: #fefefe; margin: 5% auto; padding: 25px;
            border: 1px solid #888; width: 90%; max-width: 1200px; border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2); animation: slideIn 0.3s;
        }
        @keyframes slideIn { from {transform: translateY(-50px);} to {transform: translateY(0);} }
        .modal-table { width: 100%; border-collapse: collapse; margin-top: 15px; table-layout: fixed; }
        .modal-table th, .modal-table td { border: 1px solid #ddd; padding: 8px; }
        .modal-table th { background-color: #f2f2f2; font-size: 80%; }
        .modal-table input { width: 95%; padding: 6px; border: 1px solid #ccc; border-radius: 4px; }
        .modal-table input:disabled { background-color: #e9ecef; cursor: not-allowed;}

        .col-noidung { width: 23%; }
        .col-dv-thuchien { width: 8%; }
        .col-tt, .col-donvi, .col-soluong, .col-tansuat-th, .col-capdo, .col-hoso { width: 3%; }
        .col-ghichu { width: 10%; }
        .col-chiphi, .col-thanhtien, .col-cp-giaitrinh { width: 7%; }
        .col-dvt, .col-dongia { width: 7%; }

        .modal-table th:nth-child(1), .modal-table td:nth-child(1) { width: 3%; }
        .modal-table th:nth-child(2), .modal-table td:nth-child(2) { width: 23%; }
        .modal-table th:nth-child(3), .modal-table td:nth-child(3) { width: 8%; }
        .modal-table th:nth-child(4), .modal-table td:nth-child(4) { width: 3%; }
        .modal-table th:nth-child(6), .modal-table td:nth-child(6) { width: 2%; }
        .modal-table th:nth-child(8), .modal-table td:nth-child(8) { width: 7%; }
        .modal-table th:nth-child(9), .modal-table td:nth-child(9) { width: 7%; }
        .modal-table th:nth-child(10), .modal-table td:nth-child(10) { width: 5%; }
        .modal-table th:nth-child(11), .modal-table td:nth-child(11) { width: 15%; }


        .execution-modal-table th:nth-child(1), .execution-modal-table td:nth-child(1) { width: 8%; }
        .execution-modal-table th:nth-child(2), .execution-modal-table td:nth-child(2) { width: 54%; }
        .execution-modal-table th:nth-child(3), .execution-modal-table td:nth-child(3) { width: 12%; }
        .execution-modal-table th:nth-child(4), .execution-modal-table td:nth-child(4) { width: 13%; }
        .execution-modal-table th:nth-child(5), .execution-modal-table td:nth-child(5) { width: 13%; }

        .modal-footer { text-align: right; margin-top: 20px; }
        .close-button { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }

        #scrollToTopBtn {
            display: none; position: fixed; bottom: 25px; right: 25px; z-index: 999;
            border: none; outline: none; background-color: #007bff; color: white; cursor: pointer;
            padding: 0; border-radius: 50%; font-size: 24px; width: 50px; height: 50px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3); transition: background-color: 0.3s, transform 0.2s;
        }
        #scrollToTopBtn:hover { background-color: #0056b3; transform: translateY(-2px); }

        .dropdown { position: relative; display: inline-block; }
        .dropdown-content {
            display: none; position: absolute; background-color: #f9f9f9; min-width: 160px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2); z-index: 1; right: 0; border-radius: 4px;
        }
        .dropdown-content a { color: black; padding: 12px 16px; text-decoration: none; display: block; font-size: 14px; }
        .dropdown-content a:hover { background-color: #f1f1f2; }
        .show { display: block; }

        .links-dropdown {
            display: block; position: absolute; background-color: #fff; min-width: 300px; max-width: 500px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2); z-index: 20; border-radius: 4px; border: 1px solid #ddd; padding: 5px;
        }
        .links-dropdown a {
            color: #0056b3; padding: 8px 12px; text-decoration: none; display: block; font-size: 14px;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .links-dropdown a:hover { background-color: #f1f1f1; text-decoration: underline; }

        .modal-note {
            background-color: #f8f9fa; border-left: 4px solid #007bff; padding: 10px 15px;
            margin: 15px 0; font-size: 14px; color: #495057;
        }

        #yearSelect {
            padding: 8px 12px; border: 1px solid #ccc; border-radius: 4px;
            font-size: 14px; background-color: white; cursor: pointer;
        }
        #yearSelect:focus {
            outline: none; border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
        }

        .delete-confirm-modal, .export-options-modal { max-width: 500px; }
        .delete-confirm-modal input {
            width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #ccc;
            border-radius: 4px; box-sizing: border-box;
        }

        .planning-mode .col-hoso,
        .planning-mode .col-kehoach-conlai { display: none; }
        .col-tansuat-th, .col-ghichu, .col-kh-nam-truoc, .col-cp-giaitrinh, .col-action { display: none; }
        .planning-mode + #summarySection { display: none; }
        .planning-mode .col-tansuat-th,
        .planning-mode .col-ghichu,
        .planning-mode .col-kh-nam-truoc,
        .planning-mode .col-cp-giaitrinh,
        .planning-mode .col-action { display: table-cell; }
        .planning-mode .task-justification { display: table-row; }

        .planning-mode .col-dv-thuchien { width: 4% !important; }
        .planning-mode .col-chiphi { width: 8%; }
        .planning-mode .col-chiphi-thuchien { width: 8% !important; }
        .planning-mode .col-kh-nam-truoc { width: 8% !important; }
        .planning-mode .col-ghichu { width: 12%; }
        .planning-mode .col-action { width: 4% !important; }

        #summaryDetailModal .modal-content { max-width: 95%; }
        .summary-details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .summary-parent-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            background-color: #f8f9fa;
        }
        .summary-parent-card h3 {
            margin-top: 0;
            color: #007bff;
            border-bottom: 2px solid #007bff;
            padding-bottom: 8px;
            font-size: 1.1rem;
        }
        .summary-columns-container {
            display: flex;
            justify-content: space-between;
            gap: 20px;
        }
        .summary-info-column {
            width: 50%;
            font-size: 14px;
        }
        .summary-info-column h4 {
            margin-top: 0;
            margin-bottom: 8px;
            color: #495057;
            border-bottom: 1px solid #ccc;
            padding-bottom: 4px;
            font-size: 15px;
        }
        .summary-info-column p {
            margin: 4px 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: flex;
            justify-content: space-between;
        }
        .summary-info-column p strong {
            color: #495057;
        }
        .summary-parent-card .value {
            font-weight: bold;
            color: #333;
        }
        .summary-charts-container {
            display: flex;
            justify-content: space-around;
            align-items: center;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }
        .chart-wrapper {
            width: 45%;
            max-width: 150px;
            text-align: center;
        }
        .chart-wrapper p {
            font-size: 12px;
            margin-top: 5px;
            font-weight: bold;
            color: #333;
        }


        @media screen and (max-width: 768px) {
            .responsive-modal-table thead { display: none; }
            .responsive-modal-table, .responsive-modal-table tbody, .responsive-modal-table tr, .responsive-modal-table td {
                display: block; width: 100%;
            }
            .responsive-modal-table tr { margin-bottom: 15px; border: 1px solid #ddd; border-radius: 5px; padding: 10px; }
            .responsive-modal-table td {
                display: flex; justify-content: space-between; padding-left: 50%;
                position: relative; text-align: right; border: none; padding-bottom: 5px;
            }
            .responsive-modal-table td:before {
                content: attr(data-label); position: absolute; left: 10px; width: 45%;
                padding-right: 10px; font-weight: bold; text-align: left;
            }
            .search-modal-mobile td { font-size: 12px; }
            .search-modal-mobile .btn-edit-exec { display: none; }
            .search-modal-mobile .btn-profile-exec {
                flex: 1; padding: 10px 0; font-size: 16px; margin-top: 5px;
            }
            .summary-details-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

    <div id="login-container">
        <img src="PVGLPG.gif" alt="Logo" style="width: 120px; height: auto; margin-bottom: 20px;">
        <h2>Đăng nhập Hệ thống</h2>
        <form id="login-form">
            <input type="text" id="email"
                   value="atclmt***@pvgaslpg*****"
                   data-real-email="atclmt-tk@pvgaslpg.com.vn"
                   readonly
                   style="background-color: #e9ecef; cursor: not-allowed; text-align: center; color: #495057;">
            <input type="password" id="password" placeholder="Mật khẩu" required autofocus>
            <button type="submit" class="btn-primary">Đăng nhập</button>
            <p id="login-error" style="display: none;"></p>
        </form>
    </div>

    <div id="container">
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px;">
            <img src="PVGLPG.gif" alt="Logo" style="width: 100px; height: auto;">
            <h1 style="color: #008037; font-weight: bold; text-transform: uppercase; text-align: center; flex-grow: 1;">
                LẬP VÀ THEO DÕI KẾ HOẠCH<br>AN TOÀN - CHẤT LƯỢNG - MÔI TRƯỜNG
            </h1>
            <div style="width: 150px;"></div>
        </div>

        <div class="button-group" style="padding-bottom: 10px; border-bottom: 1px solid #eee;">
            <div>
                <button class="btn-secondary" onclick="recalculateAllCostsAndReload()">Tải lại & Tính toán lại</button>
                <button class="btn-primary" onclick="openDataManagementModal()">Quản lý Dữ liệu</button>
                <button id="deleteSelectedBtn" class="btn-danger" onclick="deleteSelectedTasks()" disabled>Xoá mục đã chọn</button>
                <button id="exportExcel1Btn" class="btn-success" onclick="exportToExcel(1)">Xuất Excel 1</button>
                <button id="exportExcel2Btn" class="btn-success" onclick="exportToExcel(2)" disabled>Xuất Excel 2</button>
            </div>
        </div>
        <div id="status"></div>

        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px;">
            <h2>Các Tổng kho tại Hải Phòng</h2>
             <div>
                <label for="yearSelect" style="margin-right: 10px; font-weight: bold;">Năm:</label>
                <select id="yearSelect" onchange="changeYear(this.value)"></select>
            </div>
        </div>

        <div class="button-group" style="margin-bottom: 15px; justify-content: space-between;">
             <div>
                <button id="multiExecuteBtn" class="btn-info" onclick="openMultiExecutionModal()" disabled>Thực hiện công việc đã chọn</button>
                <button id="searchExecutionBtn" class="btn-primary" onclick="openSearchModal()">Tra cứu thực hiện</button>
             </div>
             <div style="display: flex; align-items: center;">
                <label for="planningModeToggle" style="margin-right: 10px; font-weight: bold;">Mở cột ẩn để làm kế hoạch</label>
                <input type="checkbox" id="planningModeToggle" onchange="togglePlanningColumns(this.checked)" disabled>
             </div>
        </div>

        <div id="summarySection"></div>

        <table id="taskList">
            <thead>
                <tr>
                    <th style="width: 2%;"><input type="checkbox" onchange="toggleAllCheckboxes(this)"></th>
                    <th class="col-tt" style="width: 3%;">TT</th>
                    <th class="col-noidung">Đầu việc/ Dự án</th>
                    <th class="col-dv-thuchien" style="width: 5%;">ĐV th.hiện</th>
                    <th class="col-donvi">Đ.vị tính</th>
                    <th class="col-soluong">Số lượng</th>
                    <th class="col-tansuat-th">Tần suất TH</th>
                    <th class="text-right col-cp-giaitrinh">CP giải trình</th>
                    <th class="text-right col-chiphi">Chi phí</th>
                    <th class="text-right col-chiphi-thuchien" style="width: 6%;">Chi phí thực hiện</th>
                    <th class="text-right col-kehoach-conlai" style="width: 6%;">Kế hoạch còn lại</th>
                    <th class="col-capdo">Cấp độ</th>
                    <th class="text-right col-kh-nam-truoc" style="width: 7%;">KH năm trước</th>
                    <th class="col-ghichu">Ghi chú</th>
                    <th class="col-hoso" style="width: 3%;">Hồ sơ</th>
                    <th style="width: 5%;" class="col-action">Hành động</th>
                </tr>
            </thead>
            <tbody id="taskListBody"></tbody>
        </table>
    </div>

    <div id="dataModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeAllModals()">&times;</span>
            <div id="modalTitle"></div>
            <div id="modalBody"></div>
            <div class="modal-footer">
                <div id="modal-footer-left" style="float: left;"></div>
                <button id="modalDeleteButton" class="btn-danger" style="display: none; float: left;">Xóa</button>
                <button id="modalSaveButton" class="btn-success">Lưu thay đổi</button>
            </div>
        </div>
    </div>

    <div id="dataManagementModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <span class="close-button" onclick="closeAllModals()">&times;</span>
            <h2>Quản lý Dữ liệu</h2>

            <div style="margin-top: 20px;">
                <h3>Nhập dữ liệu từ file Excel</h3>
                <input type="file" id="excelFile" accept=".xlsx, .xls">
                <p><small><i>Chú ý: để chương trình nhận đúng dữ liệu, hãy định dạng các dữ liệu số trong file Excel ở định dạng General.</i></small></p>
                <button class="btn-primary" onclick="importData()" style="margin-top: 10px;">Nhập dữ liệu</button>
            </div>

            <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #ccc;">
                <h3>Xóa toàn bộ dữ liệu</h3>
                <p style="color: #dc3545;"><strong>Cảnh báo:</strong> Hành động này không thể hoàn tác.</p>
                <button class="btn-danger" onclick="openDeleteAllDataModal()">Xoá tất cả</button>
            </div>

            <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #ccc;">
                <h3>Mở khóa sửa đổi</h3>
                <button id="unlockButton" class="btn-warning" onclick="promptForUnlock()">Mở khóa cho phép sửa đổi</button>
                <div id="editModeToggle" style="display: none; margin-top: 10px; text-align: left;">
                    <input type="checkbox" id="editModeCheckbox" onchange="toggleEditMode(this.checked)" style="width: auto;">
                    <label for="editModeCheckbox">Cho phép sửa đổi, thêm, xóa dữ liệu</label>
                </div>
            </div>

            <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #ccc;">
                <h3>Xác thực Cơ sở dữ liệu</h3>
                <p>Để có thể chỉnh sửa, thêm, xóa dữ liệu, bạn cần xác thực.</p>
                <button class="btn-info" onclick="promptForAuthentication()">Xác thực CSDL</button>
            </div>
        </div>
    </div>

    <div id="deleteAllDataModal" class="modal">
        <div class="modal-content delete-confirm-modal">
            <span class="close-button" onclick="closeAllModals()">&times;</span>
            <h2>Xác nhận xóa toàn bộ dữ liệu</h2>
            <p style="color: #dc3545; font-weight: bold;">CẢNH BÁO: Bạn sắp xóa TOÀN BỘ dữ liệu. Hành động này không thể hoàn tác.</p>
            <p>Vui lòng nhập đầy đủ thông tin đăng nhập để xác nhận:</p>
            <div>
                <input type="text" id="deleteConfirmEmail" placeholder="Email đăng nhập">
                <input type="password" id="deleteConfirmPassword" placeholder="Mật khẩu">
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeAllModals()">Hủy</button>
                <button class="btn-danger" onclick="confirmDeleteAllData()">Xác nhận xóa toàn bộ</button>
            </div>
        </div>
    </div>

    <div id="uploadPdfModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <span class="close-button" onclick="closeAllModals()">&times;</span>
            <h2 id="uploadPdfModalTitle">Tải lên Hồ sơ PDF</h2>
            <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center mt-4">
                 <input type="file" id="pdf_file_input" accept=".pdf" class="block w-full text-sm text-gray-500
                    file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold
                    file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
            </div>
            <div class="modal-footer">
                <button id="uploadPdfButton" class="btn-primary">Tải Lên</button>
            </div>
        </div>
    </div>

    <div id="exportOptionsModal" class="modal">
        <div class="modal-content export-options-modal">
            <span class="close-button" onclick="closeAllModals()">&times;</span>
            <h2>Tùy chọn Xuất file Excel</h2>
            <p>Vui lòng chọn định dạng file bạn muốn xuất:</p>
            <div style="display: flex; justify-content: space-around; margin-top: 20px; gap: 15px;">
                <button class="btn-primary" style="flex: 1; padding: 15px;" onclick="exportPlainDataExcel()">1. Tạo nhanh file Excel<br><small>(Thuần dữ liệu, không có định dạng chữ, *.xlsx)</small></button>
                <button class="btn-success" style="flex: 1; padding: 15px;" onclick="exportFormattedExcel_HTML()">2. File Excel 97 kèm định dạng chữ<br><small>(In đậm các đầu mục chính, *.xls)</small></button>
            </div>
        </div>
    </div>

    <div id="planningModeModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <span class="close-button" onclick="closePlanningModal()">&times;</span>
            <h2>Chọn phạm vi xem Kế hoạch</h2>
            <p>Vui lòng chọn dữ liệu bạn muốn hiển thị ở chế độ lập kế hoạch:</p>
            <div id="planningModeOptions" style="margin-top: 20px; max-height: 40vh; overflow-y: auto;">
            </div>
        </div>
    </div>

    <div id="summaryDetailModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeAllModals()">&times;</span>
            <h2>Chi tiết thực hiện theo từng đơn vị năm <span id="summaryDetailYear"></span></h2>
            <div id="summaryDetailContent" class="summary-details-grid">
            </div>
        </div>
    </div>

    <button id="scrollToTopBtn" title="Lên đầu trang">&uarr;</button>

    <div style="text-align: center; padding: 20px; color: #888; font-size: 12px;">
      Contact: hai.nm@pvgaslpg.com.vn
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, EmailAuthProvider, reauthenticateWithCredential, signOut } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDocs, getDoc, updateDoc, deleteDoc, writeBatch, query, serverTimestamp, collectionGroup, limit, onSnapshot } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC2mX-vBKLv9COzjJyGGUYCPCF8O2gd7Mk",
  authDomain: "atclmt-hp.firebaseapp.com",
  projectId: "atclmt-hp",
  storageBucket: "atclmt-hp.firebasestorage.app",
  messagingSenderId: "1073263541013",
  appId: "1:1073263541013:web:d77a239f9db1e66143871c",
  measurementId: "G-FY2SDW2855"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const CLIENT_ID = "588583798336-o4gjnfqaupmmdp8mi38o9m8r4n0bbghs.apps.googleusercontent.com";
        const DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"];
        const SCOPES = "https://www.googleapis.com/auth/drive.file";
        const FOLDER_ID = "1uyHJHfNFLIdPQbYu1uF4zliORCM6QK3P";

        const statusDiv = document.getElementById('status');
        let selectedTasks = new Set();
        let selectedJustifications = new Set();
        let executionGroups = new Map();
        let docDataMap = new Map();
        let tokenClient;
        let gapiReady = false;
        let editModeStatusByYear = {};
        let currentYear = new Date().getFullYear();
        let planningModeByYear = {};
        let isAuthenticated = false;
        let activeExportType = 'simplified';
        let activeCharts = [];


        const loginContainer = document.getElementById('login-container');
        const mainContainer = document.getElementById('container');
        const loginForm = document.getElementById('login-form');
        const loginError = document.getElementById('login-error');

        function showAuthError() {
            statusDiv.className = 'error';
            statusDiv.innerText = 'Lỗi: Bạn cần xác thực để thực hiện hành động này. Vui lòng vào "Quản lý dữ liệu" -> "Xác thực CSDL".';
            setTimeout(() => { if (statusDiv.innerText && statusDiv.innerText.includes('Bạn cần xác thực')) { statusDiv.innerText = ''; } }, 6000);
        }

        window.promptForAuthentication = () => {
            closeAllModals();
            loginContainer.style.display = 'block';
        };

        onAuthStateChanged(auth, user => {
            if (user) {
                isAuthenticated = true;
                loginContainer.style.display = 'none';
                mainContainer.style.display = 'block';

                const settingsDocRef = doc(db, 'settings', 'global');
                onSnapshot(settingsDocRef, (docSnap) => {
                    if (docSnap.exists()) {
                        editModeStatusByYear = docSnap.data().editModeStatus || {};
                    } else {
                        editModeStatusByYear = {};
                    }
                    updateButtonStates();
                });
                fetchData();
            } else {
                isAuthenticated = false;
                mainContainer.style.display = 'none';
                loginContainer.style.display = 'block';
                updateButtonStates();
            }
        });

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').dataset.realEmail;
            const password = document.getElementById('password').value;
            const loginButton = loginForm.querySelector('button');
            loginError.style.display = 'none';
            loginButton.disabled = true;
            loginButton.textContent = 'Đang xử lý...';
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                console.error("Lỗi đăng nhập:", error);
                let errorMessage = "Đã xảy ra lỗi. Vui lòng thử lại.";
                if (error.code === 'auth/invalid-credential') errorMessage = "Mật khẩu không chính xác.";
                loginError.textContent = errorMessage;
                loginError.style.display = 'block';
            } finally {
                loginButton.disabled = false;
                loginButton.textContent = 'Đăng nhập';
            }
        });

        window.promptForUnlock = () => {
            if (!isAuthenticated) return showAuthError();
            const password = prompt("Vui lòng nhập mật khẩu quản trị:");
            if (password === '13579') {
                document.getElementById('unlockButton').style.display = 'none';
                const toggleDiv = document.getElementById('editModeToggle');
                toggleDiv.style.display = 'block';
                document.getElementById('editModeCheckbox').checked = editModeStatusByYear[currentYear] === true;
            } else if (password !== null) {
                alert("Mật khẩu không chính xác.");
            }
        };

        window.toggleEditMode = async (isChecked) => {
            if (!isAuthenticated) {
                document.getElementById('editModeCheckbox').checked = !isChecked;
                return showAuthError();
            }
            try {
                const settingsDocRef = doc(db, 'settings', 'global');
                await setDoc(settingsDocRef, { editModeStatus: { [currentYear]: isChecked } }, { merge: true });
            } catch (error) {
                console.error("Lỗi khi cập nhật trạng thái mở khóa:", error);
                alert("Đã có lỗi xảy ra khi lưu trạng thái. Vui lòng thử lại.");
            }
        };

        function updateButtonStates() {
            const isCurrentYearEditable = editModeStatusByYear[currentYear] === true;
            const canWrite = isAuthenticated && isCurrentYearEditable;
            const planningToggle = document.getElementById('planningModeToggle');

            const multiExecuteButton = document.getElementById('multiExecuteBtn');
            multiExecuteButton.disabled = selectedTasks.size === 0;

            const deleteSelectedButton = document.getElementById('deleteSelectedBtn');
            deleteSelectedButton.disabled = !canWrite || (selectedTasks.size === 0 && selectedJustifications.size === 0);

            const actionButtons = document.querySelectorAll('#taskList .dropbtn, #taskList .btn-edit-leaf');
            actionButtons.forEach(btn => {
                btn.disabled = !canWrite;
            });

            if (canWrite) {
                planningToggle.disabled = false;
            } else {
                planningToggle.disabled = true;
                if (planningToggle.checked) {
                    planningToggle.checked = false;
                    const taskList = document.getElementById('taskList');
                    taskList.classList.remove('planning-mode');
                    document.getElementById('exportExcel1Btn').disabled = false;
                    document.getElementById('exportExcel2Btn').disabled = true;
                    const allRows = document.querySelectorAll('#taskListBody tr');
                    allRows.forEach(row => row.style.display = '');
                }
            }
        }

        window.recalculateAllCostsAndReload = async () => {
            if (!isAuthenticated) return showAuthError();
            if (!confirm("Bạn có muốn tính toán lại toàn bộ chi phí không? Hành động này sẽ quét và cập nhật tất cả các mục công việc.")) return;
            const button = document.querySelector('button[onclick="recalculateAllCostsAndReload()"]');
            try {
                statusDiv.className = 'success';
                statusDiv.innerText = 'Đang tính toán lại toàn bộ dữ liệu... Vui lòng chờ.';
                button.disabled = true;
                const fieldsToRecalculate = ['chiPhi', 'chiPhiThucHien', 'cpGiaiTrinh', 'khNamTruoc'];
                const parentSnapshot = await getDocs(query(collection(db, getParentCollectionName())));
                for (const parentDoc of parentSnapshot.docs) {
                    const childSnapshot = await getDocs(query(collection(parentDoc.ref, "công việc con")));
                    for (const childDoc of childSnapshot.docs) {
                        const grandchildSnapshot = await getDocs(query(collection(childDoc.ref, "công việc cháu")));
                        for (const grandchildDoc of grandchildSnapshot.docs) {
                            const greatGrandchildSnapshot = await getDocs(query(collection(grandchildDoc.ref, "công việc chắt")));
                            for (const greatGrandchildDoc of greatGrandchildSnapshot.docs) {
                                await recalculateSingleParentJustificationCost(greatGrandchildDoc.ref.path);
                                if (greatGrandchildDoc.data().hasChildren) {
                                    const greatGreatGrandchildSnapshot = await getDocs(query(collection(greatGrandchildDoc.ref, "công việc cụ thể")));
                                    for (const greatGreatGrandchildDoc of greatGreatGrandchildSnapshot.docs) {
                                        await recalculateSingleParentJustificationCost(greatGreatGrandchildDoc.ref.path);
                                        await recalculateExecutionCost(greatGreatGrandchildDoc.ref.path);
                                    }
                                    await recalculateSingleParentCost(greatGrandchildDoc.ref.path, 'công việc cụ thể', fieldsToRecalculate);
                                } else {
                                    await recalculateExecutionCost(greatGrandchildDoc.ref.path);
                                }
                            }
                            await recalculateSingleParentCost(grandchildDoc.ref.path, 'công việc chắt', fieldsToRecalculate);
                        }
                        await recalculateSingleParentCost(childDoc.ref.path, 'công việc cháu', fieldsToRecalculate);
                        await checkAndUpdateDaThucHien(childDoc.ref.path);
                    }
                    await recalculateSingleParentCost(parentDoc.ref.path, 'công việc con', fieldsToRecalculate);
                }
                statusDiv.innerText = 'Tính toán lại thành công! Đang tải lại dữ liệu mới...';
                await fetchData();
            } catch (error) {
                console.error("Lỗi khi tính toán lại toàn bộ:", error);
                statusDiv.className = 'error';
                statusDiv.innerText = `Đã xảy ra lỗi: ${error.message}`;
            } finally {
                button.disabled = false;
            }
        };

        const recalculateExecutionCost = async (leafNodePath) => {
            const leafNodeRef = doc(db, leafNodePath);
            const execSnapshot = await getDocs(collection(leafNodeRef, 'thực hiện'));
            const newChiPhiThucHien = execSnapshot.docs.reduce((sum, d) => sum + (d.data().thanhTien || 0), 0);
            const leafNodeSnap = await getDoc(leafNodeRef);
            if(leafNodeSnap.exists()) {
                const chiPhi = leafNodeSnap.data().chiPhi || 0;
                await updateDoc(leafNodeRef, { chiPhiThucHien: newChiPhiThucHien, keHoachConLai: chiPhi - newChiPhiThucHien });
            }
        };

        window.importData = () => {
            if (!isAuthenticated) return showAuthError();
            const fileInput = document.getElementById('excelFile');
            if (!fileInput.files.length) {
                statusDiv.className = 'error'; statusDiv.innerText = "Vui lòng chọn một file Excel (.xlsx)."; return;
            }
            const reader = new FileReader();
            reader.onload = async (event) => {
                try {
                    statusDiv.className = 'success'; statusDiv.innerText = "Đang đọc file...";
                    const workbook = XLSX.read(new Uint8Array(event.target.result), { type: 'array' });
                    const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], {
                        raw: false,
                        defval: ''
                    });
                    const headers = jsonData.length > 0 ? Object.keys(jsonData[0]) : [];
                    statusDiv.innerText = "Đã đọc file. Đang xử lý...";

                    const taskTree = buildTaskTree(jsonData, headers);
                    calculateCosts(taskTree);
                    statusDiv.innerText = "Đang nhập dữ liệu vào Firestore...";
                    await writeTreeToFirestore(taskTree);
                    statusDiv.innerText = "Nhập dữ liệu thành công! Đang tải lại danh sách...";
                    closeAllModals();
                    await fetchData();
                } catch (error) { console.error("Lỗi khi nhập: ", error); statusDiv.className = 'error'; statusDiv.innerText = `Lỗi: ${error.message}`; }
            };
            reader.readAsArrayBuffer(fileInput.files[0]);
        };

        const writeTreeToFirestore = async (tree) => {
            const batch = writeBatch(db);
            const processNode = (node, path) => {
                if (node.data && Object.keys(node.data).length > 1) {
                    batch.set(doc(db, path), node.data, { merge: true });
                }

                if (node.justifications) {
                    node.justifications.forEach(just => {
                        batch.set(doc(db, `${path}/giải trình`, just.id), just.data, { merge: true });
                    });
                }

                if (node.children) {
                    node.children.forEach(child => processNode(child, `${path}/công việc con/${child.id}`));
                }
                if (node.grandchildren) {
                    node.grandchildren.forEach(grandchild => processNode(grandchild, `${path}/công việc cháu/${grandchild.id}`));
                }
                if (node.greatGrandchildren) {
                    node.greatGrandchildren.forEach(ggc => {
                        const ggcPath = `${path}/công việc chắt/${ggc.id}`;
                        processNode(ggc, ggcPath);

                        if ((!ggc.greatGreatGrandchildren || ggc.greatGreatGrandchildren.length === 0) && ggc.executions && ggc.executions.length > 0) {
                            ggc.executions.forEach(exec => {
                                const execDocRef = doc(collection(db, ggcPath, "thực hiện"), String(exec.lanThucHien));
                                batch.set(execDocRef, exec);
                            });
                        }
                    });
                }
                if (node.greatGreatGrandchildren) {
                     node.greatGreatGrandchildren.forEach(gggc => {
                        const gggcPath = `${path}/công việc cụ thể/${gggc.id}`;
                        processNode(gggc, gggcPath);
                        if (gggc.executions && gggc.executions.length > 0) {
                            gggc.executions.forEach(exec => {
                                const execDocRef = doc(collection(db, gggcPath, "thực hiện"), String(exec.lanThucHien));
                                batch.set(execDocRef, exec);
                            });
                        }
                    });
                }
            };

            tree.forEach(p => processNode(p, `${getParentCollectionName()}/${p.id}`));

            await batch.commit();
        };

        window.openDeleteAllDataModal = () => {
            if (!isAuthenticated) return showAuthError();
            document.getElementById('deleteAllDataModal').style.display = 'block';
            document.getElementById('deleteConfirmEmail').value = '';
            document.getElementById('deleteConfirmPassword').value = '';
        };

        window.confirmDeleteAllData = async () => {
            if (!isAuthenticated) return showAuthError();
            const email = document.getElementById('deleteConfirmEmail').value;
            const password = document.getElementById('deleteConfirmPassword').value;
            if (!email || !password) { alert('Vui lòng nhập đầy đủ email và mật khẩu.'); return; }
            const deleteButton = document.querySelector('#deleteAllDataModal .btn-danger');
            try {
                deleteButton.disabled = true;
                deleteButton.textContent = 'Đang xác nhận...';
                const credential = EmailAuthProvider.credential(email, password);
                await reauthenticateWithCredential(auth.currentUser, credential);
                statusDiv.className = 'success'; statusDiv.innerText = "Đã xác thực thành công. Đang tiến hành xóa...";
                const parentSnapshot = await getDocs(query(collection(db, getParentCollectionName())));
                for (const parentDoc of parentSnapshot.docs) {
                    const childSnapshot = await getDocs(query(collection(parentDoc.ref, "công việc con")));
                    for (const childDoc of childSnapshot.docs) {
                        const grandchildSnapshot = await getDocs(query(collection(childDoc.ref, "công việc cháu")));
                        for (const grandchildDoc of grandchildSnapshot.docs) {
                            const greatGrandchildSnapshot = await getDocs(query(collection(grandchildDoc.ref, "công việc chắt")));
                            for (const greatGrandchildDoc of greatGrandchildSnapshot.docs) {
                                const justificationSnapshot1 = await getDocs(query(collection(greatGrandchildDoc.ref, "giải trình")));
                                for(const justDoc of justificationSnapshot1.docs) await deleteDoc(justDoc.ref);
                                const greatGreatGrandchildSnapshot = await getDocs(query(collection(greatGrandchildDoc.ref, "công việc cụ thể")));
                                for (const greatGreatGrandchildDoc of greatGreatGrandchildSnapshot.docs) {
                                    const justificationSnapshot2 = await getDocs(query(collection(greatGreatGrandchildDoc.ref, "giải trình")));
                                    for(const justDoc of justificationSnapshot2.docs) await deleteDoc(justDoc.ref);
                                    const executionSnapshot = await getDocs(query(collection(greatGreatGrandchildDoc.ref, "thực hiện")));
                                    for(const execDoc of executionSnapshot.docs) await deleteDoc(execDoc.ref);
                                    await deleteDoc(greatGreatGrandchildDoc.ref);
                                }
                                const executionSnapshot = await getDocs(query(collection(greatGrandchildDoc.ref, "thực hiện")));
                                for(const execDoc of executionSnapshot.docs) await deleteDoc(execDoc.ref);
                                await deleteDoc(greatGrandchildDoc.ref);
                            }
                            await deleteDoc(grandchildDoc.ref);
                        }
                        await deleteDoc(childDoc.ref);
                    }
                    await deleteDoc(parentDoc.ref);
                }
                statusDiv.innerText = "Đã xoá thành công.";
                closeAllModals();
                await fetchData();
            } catch (error) {
                console.error("Lỗi khi xoá: ", error);
                if (error.code === 'auth/invalid-credential') {
                    alert('Email hoặc mật khẩu không chính xác. Thao tác xóa đã bị hủy.');
                } else {
                    statusDiv.className = 'error';
                    statusDiv.innerText = "Lỗi khi xoá: " + error.message;
                }
            } finally {
                deleteButton.disabled = false;
                deleteButton.textContent = 'Xác nhận xóa toàn bộ';
            }
        };

        const saveTasks = async () => {
            if (!isAuthenticated) return showAuthError();
            const saveButton = document.getElementById('modalSaveButton');
            try {
                saveButton.disabled = true; saveButton.textContent = 'Đang lưu...';
                const batch = writeBatch(db);
                const rows = document.querySelectorAll("#dataModal .modal-table tbody tr");
                const pathsToRecalculate = new Set();
                const justificationPathsToRecalculate = new Set();

                for(const row of rows) {
                    const path = row.dataset.path;
                    const docRef = doc(db, path);
                    const updatedData = {};
                    row.querySelectorAll('input[data-field]').forEach(input => {
                        const field = input.dataset.field;
                        if (['cpGiaiTrinh', 'chiPhi', 'khNamTruoc'].includes(field)) {
                            updatedData[field] = parseFormattedNumber(input.value);
                        } else if (field === 'tanSuatTH') {
                            const value = parseInt(input.value, 10);
                            updatedData[field] = isNaN(value) || value < 0 ? 0 : value;
                        } else {
                           updatedData[field] = input.value;
                        }
                    });

                    if (path.includes('giải trình')) {
                        justificationPathsToRecalculate.add(path.substring(0, path.lastIndexOf('/giải trình/')));
                    } else {
                        pathsToRecalculate.add(path);
                        const docSnap = await getDoc(docRef);
                        if (docSnap.exists() && !docSnap.data().hasChildren) {
                            const chiPhi = updatedData.chiPhi || 0;
                            const chiPhiThucHien = docSnap.data().chiPhiThucHien || 0;
                            updatedData.keHoachConLai = chiPhi - chiPhiThucHien;
                        }
                    }
                    batch.update(docRef, updatedData);
                }
                await batch.commit();

                if(justificationPathsToRecalculate.size > 0) await recalculateJustificationCostForParents(Array.from(justificationPathsToRecalculate));
                if(pathsToRecalculate.size > 0) await recalculateCostsForParents(Array.from(pathsToRecalculate));

                closeAllModals();
                await fetchData();
                statusDiv.className = 'success'; statusDiv.innerText = `Đã cập nhật ${rows.length} công việc.`;
            } catch (error) {
                console.error("Lỗi khi lưu:", error);
                statusDiv.className = 'error'; statusDiv.innerText = `Lỗi khi lưu: ${error.message}`;
            } finally {
                saveButton.disabled = false; saveButton.textContent = 'Lưu thay đổi';
            }
        };

        window.addNewTask = async (parentPath, level, newTT) => {
            if (!isAuthenticated) return showAuthError();
            const row = document.querySelector("#dataModal .modal-table tbody tr");
            const newData = { tt: newTT };
             row.querySelectorAll('input[data-field]').forEach(input => {
                const field = input.dataset.field;
                if(level !== 'justification') {
                    if (field === 'tanSuatTH') {
                        const value = parseInt(input.value, 10);
                        newData[field] = isNaN(value) || value < 0 ? 0 : value;
                    } else if (['chiPhi', 'cpGiaiTrinh', 'khNamTruoc'].includes(field)) {
                        newData[field] = parseFormattedNumber(input.value);
                    } else {
                        newData[field] = input.value;
                    }
                } else {
                    newData[field] = (field === 'cpGiaiTrinh') ? parseFormattedNumber(input.value) : input.value;
                }
            });

            if (level !== 'justification') {
                 newData.isHidden = false;
                 newData.chiPhi = newData.chiPhi || 0;
                 newData.chiPhiThucHien = 0;
                 newData.keHoachConLai = newData.chiPhi;
                 newData.cpGiaiTrinh = 0;
                 newData.khNamTruoc = newData.khNamTruoc || 0;
            } else {
                newData.cpGiaiTrinh = newData.cpGiaiTrinh || 0;
            }

            if (!newData.noiDung) { alert("Nội dung không được để trống!"); return; }

            let subCollectionName;
            if (level === 'child') subCollectionName = 'công việc con';
            else if (level === 'grandchild') subCollectionName = 'công việc cháu';
            else if (level === 'greatGrandchild') subCollectionName = 'công việc chắt';
            else if (level === 'greatGreatGrandchild') subCollectionName = 'công việc cụ thể';
            else if (level === 'justification') subCollectionName = 'giải trình';


            const newDocPath = `${parentPath}/${subCollectionName}/${newTT}`;
            const parentRef = doc(db, parentPath);
            const batch = writeBatch(db);

            if (level === 'greatGreatGrandchild') {
                 const parentSnap = await getDoc(parentRef);
                 if (parentSnap.exists() && !parentSnap.data().hasChildren) {
                     const execSnapshot = await getDocs(query(collection(parentRef, 'thực hiện'), limit(1)));
                     const justSnapshot = await getDocs(query(collection(parentRef, 'giải trình'), limit(1)));
                     if (!execSnapshot.empty || !justSnapshot.empty) {
                         alert('Lỗi: Không thể thêm công việc con vào một mục đã được thực hiện hoặc đã có giải trình. Vui lòng xóa các mục đó trước.');
                         return;
                     }
                     batch.update(parentRef, { hasChildren: true, chiPhi: 0, chiPhiThucHien: 0, keHoachConLai: 0, soLuong: '', donVi: '' });
                 } else if (parentSnap.exists() && parentSnap.data().hasChildren) {
                 } else {
                     batch.update(parentRef, { hasChildren: true });
                 }
            }

            batch.set(doc(db, newDocPath), newData);
            await batch.commit();

            if (level === 'justification') {
                await recalculateJustificationCostForParents([parentPath]);
            } else {
                await recalculateCostsForParents([newDocPath]);
            }

            closeAllModals();
            await fetchData();
            statusDiv.className = 'success'; statusDiv.innerText = 'Thêm mục mới thành công!';
        };

        window.saveMultiExecutionData = async () => {
            if (!isAuthenticated) return showAuthError();
            const saveButton = document.getElementById('modalSaveButton');
            try {
                saveButton.disabled = true; saveButton.textContent = 'Đang lưu...';
                const batch = writeBatch(db);
                const rows = document.querySelectorAll("#dataModal .modal-table tbody tr");
                const ngayThucHien = document.getElementById('executionDate').value;
                if (!ngayThucHien) throw new Error("Vui lòng chọn ngày thực hiện.");
                statusDiv.className = 'success'; statusDiv.innerText = "Đang lưu dữ liệu thực hiện...";
                const commonTimestamp = serverTimestamp();
                const pathsToRecalculate = [];
                const childPathsToUpdate = new Set();

                for (const row of rows) {
                    const leafNodePath = row.dataset.path;
                    const leafNodeDocRef = doc(db, leafNodePath);
                    const leafNodeDocSnap = await getDoc(leafNodeDocRef);
                    if (!leafNodeDocSnap.exists()) continue;

                    const pathParts = leafNodeDocRef.path.split('/');
                    const childPath = pathParts.slice(0, 4).join('/');
                    childPathsToUpdate.add(childPath);

                    const leafNodeData = leafNodeDocSnap.data();
                    const initialChiPhi = leafNodeData.chiPhi || 0;
                    const soLuong = parseNumber(row.querySelector('input[data-field="dvt"]').value);
                    const thanhTien = parseFormattedNumber(row.querySelector('input[data-field="thanhTien"]').value);
                    if (thanhTien <= 0 && (initialChiPhi !== 0 || soLuong <= 0)) continue;

                    pathsToRecalculate.push(leafNodePath);
                    const executionCollectionRef = collection(leafNodeDocRef, 'thực hiện');
                    const executionSnapshot = await getDocs(query(executionCollectionRef));
                    const lanThucHien = executionSnapshot.size + 1;
                    const newExecutionData = { dvt: soLuong, donGia: parseNumber(row.querySelector('input[data-field="donGia"]').value), thanhTien: thanhTien, lanThucHien: lanThucHien, ngayThucHien: ngayThucHien, timestamp: commonTimestamp };
                    batch.set(doc(executionCollectionRef, String(lanThucHien)), newExecutionData);

                    const currentThucHien = leafNodeData.chiPhiThucHien || 0;
                    const newThucHien = currentThucHien + thanhTien;
                    batch.update(leafNodeDocRef, { chiPhiThucHien: newThucHien, keHoachConLai: leafNodeData.chiPhi - newThucHien });
                }
                childPathsToUpdate.forEach(path => {
                    batch.update(doc(db, path), { daThucHien: true });
                });
                await batch.commit();
                await recalculateCostsForParents(pathsToRecalculate);
                for (const childPath of childPathsToUpdate) {
                    await checkAndUpdateDaThucHien(childPath);
                }
                closeAllModals();
                await fetchData();
                statusDiv.innerText = `Đã lưu các mục thực hiện thành công.`;
            } catch (error) {
                console.error("Lỗi khi lưu thực hiện:", error);
                statusDiv.className = 'error'; statusDiv.innerText = `Lỗi khi lưu: ${error.message}`;
            } finally {
                saveButton.disabled = false; saveButton.textContent = 'Lưu thay đổi';
            }
        };

        window.saveExecutionEdits = async () => {
            if (!isAuthenticated) return showAuthError();
            const saveButton = document.getElementById('modalSaveButton');
            try {
                saveButton.disabled = true; saveButton.textContent = 'Đang lưu...';
                const batch = writeBatch(db);
                const rows = document.querySelectorAll("#dataModal .modal-table tbody tr");
                const pathsToRecalculate = new Set();
                const childPathsToUpdate = new Set();

                for (const row of rows) {
                    const execPath = row.dataset.execPath;
                    const parentLeafNodePath = execPath.substring(0, execPath.lastIndexOf('/thực hiện/'));
                    const childPath = parentLeafNodePath.split('/').slice(0, 4).join('/');
                    pathsToRecalculate.add(parentLeafNodePath);
                    childPathsToUpdate.add(childPath);
                    const updatedData = {
                        dvt: parseNumber(row.querySelector('input[data-field="dvt"]').value),
                        donGia: parseNumber(row.querySelector('input[data-field="donGia"]').value),
                        thanhTien: parseFormattedNumber(row.querySelector('input[data-field="thanhTien"]').value)
                    };
                    batch.update(doc(db, execPath), updatedData);
                }
                childPathsToUpdate.forEach(path => {
                    batch.update(doc(db, path), { daThucHien: true });
                });
                await batch.commit();
                const recalcPromises = Array.from(pathsToRecalculate).map(path => recalculateExecutionCost(path));
                await Promise.all(recalcPromises);
                for (const childPath of childPathsToUpdate) {
                    await checkAndUpdateDaThucHien(childPath);
                }
                await recalculateCostsForParents(Array.from(pathsToRecalculate));
                closeAllModals();
                await fetchData();
                statusDiv.className = 'success'; statusDiv.innerText = "Đã cập nhật thành công lần thực hiện.";
            } catch (error) {
                console.error("Lỗi khi sửa thực hiện:", error);
                statusDiv.className = 'error'; statusDiv.innerText = `Lỗi khi sửa: ${error.message}`;
            } finally {
                saveButton.disabled = false; saveButton.textContent = 'Lưu thay đổi';
            }
        };

        window.handleDeleteExecution = async (timestampKey) => {
            if (!isAuthenticated) return showAuthError();
            if (!confirm("Bạn có chắc chắn muốn xóa lần thực hiện này không? Hành động này không thể hoàn tác.")) return;
            const exportBeforeDelete = confirm("Bạn có muốn xuất chi tiết lần thực hiện này ra Excel trước khi xóa không?");
            try {
                if (exportBeforeDelete) {
                    await exportSingleExecutionToExcel(timestampKey);
                    statusDiv.innerText = "Xuất Excel thành công. Chuẩn bị xóa...";
                }
                statusDiv.className = 'success';
                statusDiv.innerText = "Đang xóa dữ liệu...";
                const group = Object.values(executionGroups.get(timestampKey)).flat();
                const batch = writeBatch(db);
                const pathsToRecalculate = new Set(group.map(exec => exec.parentLeafNodePath));
                const childPathsToCheck = new Set(group.map(exec => exec.parentChildPath));
                group.forEach(exec => batch.delete(doc(db, exec.path)));
                await batch.commit();
                statusDiv.innerText = "Đã xóa. Đang cập nhật lại chi phí và trạng thái...";
                const recalcPromises = Array.from(pathsToRecalculate).map(path => recalculateExecutionCost(path));
                await Promise.all(recalcPromises);
                for (const childPath of childPathsToCheck) {
                    await checkAndUpdateDaThucHien(childPath);
                }
                await recalculateCostsForParents(Array.from(pathsToRecalculate));
                closeAllModals();
                await fetchData();
                statusDiv.innerText = "Đã xóa thành công lần thực hiện.";
            } catch (error) {
                 console.error("Lỗi khi xóa thực hiện:", error);
                 statusDiv.className = 'error';
                 statusDiv.innerText = `Lỗi khi xóa: ${error.message}`;
            }
        };

        async function performPdfUpload(timestampKey) {
            if (!isAuthenticated) return showAuthError();
            const uploadButton = document.getElementById('uploadPdfButton');
            const fileInput = document.getElementById('pdf_file_input');
            const file = fileInput.files[0];
            if (!file) { alert('Vui lòng chọn một tệp PDF.'); return; }
            try {
                uploadButton.disabled = true; uploadButton.textContent = 'Đang tải...';
                statusDiv.className = 'success'; statusDiv.innerText = 'Đang tải tệp lên Google Drive...';
                const metadata = { name: file.name, mimeType: 'application/pdf', parents: [FOLDER_ID] };
                const formData = new FormData();
                formData.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                formData.append('file', file);
                const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${gapi.client.getToken().access_token}` },
                    body: formData
                });
                if (!response.ok) { const error = await response.json(); throw new Error(`Lỗi API: ${error.error.message}`); }
                const fileData = await response.json();
                const fileLink = `https://drive.google.com/file/d/${fileData.id}/view`;
                statusDiv.innerText = 'Đang lưu đường link vào cơ sở dữ liệu...';
                const group = Object.values(executionGroups.get(timestampKey) || {}).flat();
                if (group.length > 0) {
                    const batch = writeBatch(db);
                    group.forEach(exec => batch.update(doc(db, exec.path), { hoSoLink: fileLink }));
                    const childPathsToUpdate = new Set(group.map(exec => exec.parentChildPath));
                     childPathsToUpdate.forEach(path => {
                        batch.update(doc(db, path), { daThucHien: true });
                    });
                    await batch.commit();
                }
                closeAllModals();
                await fetchData();
                statusDiv.innerText = `Tải lên và cập nhật hồ sơ thành công!`;
            } catch (error) {
                console.error('Lỗi khi tải tệp hồ sơ:', error);
                statusDiv.className = 'error';
                statusDiv.innerText = `Đã xảy ra lỗi: ${error.message}`;
            } finally {
                uploadButton.disabled = false;
                uploadButton.textContent = 'Tải Lên';
            }
        }

        window.deleteSelectedTasks = async () => {
            if (!isAuthenticated) return showAuthError();
            if (selectedTasks.size === 0 && selectedJustifications.size === 0) { alert("Vui lòng chọn ít nhất một mục để xoá."); return; }

            try {
                for (const path of selectedTasks) {
                    const execSnapshot = await getDocs(query(collection(db, path, 'thực hiện')));
                    if (!execSnapshot.empty) {
                        const taskDoc = await getDoc(doc(db, path));
                        const taskName = taskDoc.exists() ? taskDoc.data().noiDung : 'không xác định';
                        alert(`Công việc "${taskName}" (Mục ${taskDoc.data().tt}) đã được thực hiện nên không được phép xóa.`);
                        return;
                    }
                }
            } catch (error) {
                statusDiv.className = 'error'; statusDiv.innerText = `Lỗi khi kiểm tra công việc: ${error.message}`; return;
            }

            const totalToDelete = selectedTasks.size + selectedJustifications.size;
            if (!confirm(`Bạn có chắc chắn muốn xoá vĩnh viễn ${totalToDelete} mục đã chọn không?`)) return;

            const deleteButton = document.getElementById('deleteSelectedBtn');
            try {
                deleteButton.disabled = true;
                statusDiv.className = 'success'; statusDiv.innerText = `Đang xoá ${totalToDelete} mục...`;
                const batch = writeBatch(db);
                const allPathsToDelete = [...selectedTasks, ...selectedJustifications];
                const taskPathsToRecalculate = new Set();
                const justPathsToRecalculate = new Set();
                const parentsToUpdate = new Map();

                for (const path of allPathsToDelete) {
                    batch.delete(doc(db, path));
                    if (path.includes('giải trình')) {
                        justPathsToRecalculate.add(path.substring(0, path.lastIndexOf('/giải trình/')));
                    } else {
                        taskPathsToRecalculate.add(path);
                        if (path.includes('công việc cụ thể')) {
                            const parentPath = path.substring(0, path.lastIndexOf('/công việc cụ thể/'));
                            if (!parentsToUpdate.has(parentPath)) {
                                parentsToUpdate.set(parentPath, (await getDocs(query(collection(db, parentPath, 'công việc cụ thể')))).size);
                            }
                        }
                    }
                }

                await batch.commit();

                const updateBatch = writeBatch(db);
                for (const [parentPath, childCount] of parentsToUpdate.entries()) {
                    if (childCount === 1) { 
                         updateBatch.update(doc(db, parentPath), { hasChildren: false });
                    }
                }
                await updateBatch.commit();

                statusDiv.innerText = "Đã xoá. Đang tính toán lại chi phí...";
                if (justPathsToRecalculate.size > 0) await recalculateJustificationCostForParents(Array.from(justPathsToRecalculate));
                if (taskPathsToRecalculate.size > 0) await recalculateCostsForParents(Array.from(taskPathsToRecalculate));

                await fetchData();
                statusDiv.innerText = `Đã xoá thành công ${totalToDelete} mục.`;
            } catch (error) {
                console.error("Lỗi khi xoá công việc:", error);
                statusDiv.className = 'error'; statusDiv.innerText = `Lỗi khi xoá: ${error.message}`;
            } finally {
                updateButtonStates();
            }
        };

        const formatNumber = (num) => num?.toLocaleString('vi-VN') || '0';
        const parseNumber = (str) => {
            if (str === null || str === undefined) return 0;
            let s = String(str).trim();
            if (s === '') return 0;
            const lastDot = s.lastIndexOf('.');
            const lastComma = s.lastIndexOf(',');
            let numberStr;
            if (lastComma > lastDot) {
                numberStr = s.replace(/\./g, '').replace(',', '.');
            } else {
                numberStr = s.replace(/,/g, '');
            }
            const result = parseFloat(numberStr);
            return isNaN(result) ? 0 : result;
        };
        const parseFormattedNumber = (str) => {
            if (str === null || str === undefined) return 0;
            let s = String(str).trim();
            if (s === '') return 0;
            const numberStr = s.replace(/\./g, '').replace(',', '.');
            const result = parseFloat(numberStr);
            return isNaN(result) ? 0 : result;
        };
        function initializeGoogleClients() {
            gapi.load('client', async () => {
                await gapi.client.init({ discoveryDocs: DISCOVERY_DOCS });
                gapiReady = true;
            });
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: () => {},
            });
        }
        function ensureGapiAuthenticated() {
            return new Promise((resolve, reject) => {
                if (gapi.client.getToken()) return resolve(gapi.client.getToken());
                tokenClient.requestAccessToken({ prompt: '' });
                tokenClient.callback = (resp) => {
                    if (resp.error) reject(resp.error);
                    else resolve(resp);
                    tokenClient.callback = () => {};
                };
            });
        }

        const buildTaskTree = (jsonData, headers) => {
            const tree = [];
            let currentParent = null, currentChild = null, currentGrandchild = null, currentGreatGrandchild = null;
            let lastLeafNode = null;

            const isParent = /^[A-Z]$/;
            const isChild = /^[A-Z]\.\d+$/;
            const isJustification = /^[a-z]$/;

            const isGrandchild = /^\d+$/;
            const isGreatGrandchild = /^\d+\.\d+$/;
            const isGreatGreatGrandchild = /^\d+\.\d+\.\d+$/;

            const fieldMapping = {
                noiDung: ['Đầu việc', 'Dự án', 'Nội dung', 'NỘI DUNG CÔNG VIỆC'],
                ghiChu: ['Ghi chú'],
                donVi: ['đơn vị tính', 'Đ.vị tính', 'Đơn vị', 'đơn vị'],
                soLuong: ['Số lượng', 'Số lượng vật tư'],
                tanSuatTH: ['Tần suất TH', 'Tần suất thực hiện'],
                dvThucHien: ['ĐV th.hiện', 'Đơn vị thực hiện'],
                capDo: ['Cấp độ'],
                chiPhi: ['Chi phí', 'Chi phí kế hoạch'],
                khNamTruoc: ['KH năm trước', 'Kế hoạch năm trước'],
                cpGiaiTrinh: ['CP giải trình']
            };

            const findValue = (row, keys) => {
                for (const key of keys) {
                    const lowerKey = key.toLowerCase();
                    const originalHeader = headers.find(h => h.toLowerCase().includes(lowerKey));
                    if (originalHeader && row[originalHeader] !== undefined && row[originalHeader] !== null && row[originalHeader] !== '') {
                        return row[originalHeader];
                    }
                }
                return undefined;
            };

            const readExecutionsForRow = (row) => {
                const executions = [];
                let i = 1;
                while (true) {
                    const ngayTHKey = `Ngày TH (${i})`,
                          hoSoLinkKey = `Hồ sơ Link (${i})`;
                    if (!headers.includes(ngayTHKey) && !headers.includes(`Số lượng (${i})`) && !headers.includes(hoSoLinkKey)) break;
                    
                    const ngayThucHien = row[ngayTHKey],
                          dvt = parseNumber(row[`Số lượng (${i})`]),
                          thanhTien = parseNumber(row[`Thành tiền (${i})`]),
                          hoSoLink = row[hoSoLinkKey];
                          
                    if (ngayThucHien || dvt > 0 || thanhTien > 0 || hoSoLink) {
                        executions.push({
                            ngayThucHien,
                            dvt,
                            donGia: parseNumber(row[`Đơn giá (${i})`]),
                            thanhTien,
                            timestamp: row[`Timestamp (${i})`] || null,
                            lanThucHien: i,
                            hoSoLink: hoSoLink || null
                        });
                    }
                    i++;
                }
                return executions;
            };

            jsonData.forEach((row) => {
                const tt = String(row.TT || '').trim();
                if (!tt) return;

                const data = { tt };
                for (const [field, keys] of Object.entries(fieldMapping)) {
                    const value = findValue(row, keys);
                    if (value !== undefined && value !== '') {
                        if (['chiPhi', 'cpGiaiTrinh', 'khNamTruoc'].includes(field)) data[field] = parseNumber(value);
                        else if (field === 'tanSuatTH') data[field] = Math.max(0, parseInt(value, 10)) || 0;
                        else data[field] = value;
                    }
                }

                if (isJustification.test(tt) && lastLeafNode) {
                    if (!lastLeafNode.justifications) {
                        lastLeafNode.justifications = [];
                    }
                    lastLeafNode.justifications.push({ id: tt, data: data });
                    return;
                }

                const taskNode = { id: tt, data };

                if (isGreatGreatGrandchild.test(tt) && currentGreatGrandchild) {
                    const parentId = tt.substring(0, tt.lastIndexOf('.'));
                    if (currentGreatGrandchild.id === parentId) {
                        
                        if (currentGreatGrandchild.greatGreatGrandchildren.length === 0 && currentGreatGrandchild.executions) {
                            currentGreatGrandchild.executions = [];
                        }

                        taskNode.executions = readExecutionsForRow(row);
                        
                        if (!currentGreatGrandchild.greatGreatGrandchildren) currentGreatGrandchild.greatGreatGrandchildren = [];
                        currentGreatGrandchild.greatGreatGrandchildren.push(taskNode);
                        lastLeafNode = taskNode;
                    }
                } else if (isGreatGrandchild.test(tt) && currentGrandchild) {
                    taskNode.greatGreatGrandchildren = [];
                    
                    taskNode.executions = readExecutionsForRow(row);

                    if (!currentGrandchild.greatGrandchildren) currentGrandchild.greatGrandchildren = [];
                    currentGrandchild.greatGrandchildren.push(taskNode);
                    currentGreatGrandchild = taskNode;
                    lastLeafNode = taskNode;
                } else if (isGrandchild.test(tt) && !isChild.test(tt) && !isParent.test(tt) && currentChild) {
                     taskNode.greatGrandchildren = [];
                     if (!currentChild.grandchildren) currentChild.grandchildren = [];
                     currentChild.grandchildren.push(taskNode);
                     currentGrandchild = taskNode;
                     currentGreatGrandchild = null;
                     lastLeafNode = null;
                } else if (isChild.test(tt)) {
                    currentParent = tree.find(p => p.id === tt.split('.')[0]);
                    if (currentParent) {
                        taskNode.grandchildren = [];
                        if (!currentParent.children) currentParent.children = [];
                        currentParent.children.push(taskNode);
                        currentChild = taskNode;
                        currentGrandchild = null;
                        currentGreatGrandchild = null;
                        lastLeafNode = null;
                    }
                } else if (isParent.test(tt)) {
                    taskNode.children = [];
                    tree.push(taskNode);
                    currentParent = taskNode;
                    currentChild = null;
                    currentGrandchild = null;
                    currentGreatGrandchild = null;
                    lastLeafNode = null;
                }
            });
            return tree;
        };

        const calculateCosts = (tree) => {
            tree.forEach(parent => {
                let parentChiPhi = 0, parentChiPhiThucHien = 0, parentKhNamTruoc = 0;
                (parent.children || []).forEach(child => {
                    let childChiPhi = 0, childChiPhiThucHien = 0, childKhNamTruoc = 0;
                    (child.grandchildren || []).forEach(grandchild => {
                        let grandchildChiPhi = 0, grandchildChiPhiThucHien = 0, grandchildKhNamTruoc = 0;
                        (grandchild.greatGrandchildren || []).forEach(ggc => {
                             if ((ggc.greatGreatGrandchildren || []).length > 0) {
                                ggc.data.hasChildren = true;
                                const ggcChiPhi = ggc.greatGreatGrandchildren.reduce((s, gggc) => s + (gggc.data.chiPhi || 0), 0);
                                const ggcChiPhiThucHien = ggc.greatGreatGrandchildren.reduce((s, gggc) => s + (gggc.data.chiPhiThucHien || 0), 0);
                                const ggcKhNamTruoc = ggc.greatGreatGrandchildren.reduce((s, gggc) => s + (gggc.data.khNamTruoc || 0), 0);
                                ggc.data.chiPhi = ggcChiPhi;
                                ggc.data.chiPhiThucHien = ggcChiPhiThucHien;
                                ggc.data.khNamTruoc = ggcKhNamTruoc;
                            } else {
                                ggc.data.hasChildren = false;
                            }
                            if (ggc.data) {
                                ggc.data.keHoachConLai = (ggc.data.chiPhi || 0) - (ggc.data.chiPhiThucHien || 0);
                                grandchildChiPhi += ggc.data.chiPhi || 0;
                                grandchildChiPhiThucHien += ggc.data.chiPhiThucHien || 0;
                                grandchildKhNamTruoc += ggc.data.khNamTruoc || 0;
                            }
                        });
                        if (grandchild.data) {
                            grandchild.data.chiPhi = grandchildChiPhi;
                            grandchild.data.chiPhiThucHien = grandchildChiPhiThucHien;
                            grandchild.data.khNamTruoc = grandchildKhNamTruoc;
                            grandchild.data.keHoachConLai = grandchildChiPhi - grandchildChiPhiThucHien;
                        }
                        childChiPhi += grandchildChiPhi;
                        childChiPhiThucHien += grandchildChiPhiThucHien;
                        childKhNamTruoc += grandchildKhNamTruoc;
                    });
                     if (child.data) {
                        child.data.chiPhi = childChiPhi;
                        child.data.chiPhiThucHien = childChiPhiThucHien;
                        child.data.khNamTruoc = childKhNamTruoc;
                        child.data.keHoachConLai = childChiPhi - childChiPhiThucHien;
                    }
                    parentChiPhi += childChiPhi;
                    parentChiPhiThucHien += childChiPhiThucHien;
                    parentKhNamTruoc += childKhNamTruoc;
                });
                if(parent.data) {
                  parent.data.chiPhi = parentChiPhi;
                  parent.data.chiPhiThucHien = parentChiPhiThucHien;
                  parent.data.khNamTruoc = parentKhNamTruoc;
                  parent.data.keHoachConLai = parentChiPhi - parentChiPhiThucHien;
                }
            });
        };
        const childSort = (a, b) => {
            const partsA = a.id.split('.'), partsB = b.id.split('.');
            const parentCompare = partsA[0].localeCompare(partsB[0]);
            if (parentCompare !== 0) return parentCompare;
            return parseInt(partsA[1], 10) - parseInt(partsB[1], 10);
        };
        const numericSort = (a, b) => {
            const partsA = String(a.id).split('.').map(v => parseInt(v, 10));
            const partsB = String(b.id).split('.').map(v => parseInt(v, 10));
            const len = Math.max(partsA.length, partsB.length);
            for (let i = 0; i < len; i++) {
                const valA = partsA[i] || 0, valB = partsB[i] || 0;
                if (valA !== valB) return valA - valB;
            }
            return 0;
        };

        window.toggleDropdown = (event) => {
            event.stopPropagation();
            document.querySelectorAll(".dropdown-content").forEach(content => {
                if (content !== event.target.nextElementSibling) content.classList.remove('show');
            });
            event.target.nextElementSibling.classList.toggle("show");
        };
        window.showLinks = (event) => {
            event.stopPropagation();
            const existingDropdown = document.getElementById('links-dropdown-container');
            if (existingDropdown) existingDropdown.remove();
            const button = event.target;
            const links = JSON.parse(button.dataset.links);
            if (!links || links.length === 0) return;
            const dropdown = document.createElement('div');
            dropdown.id = 'links-dropdown-container';
            dropdown.className = 'links-dropdown';
            links.forEach(link => {
                const a = document.createElement('a');
                a.href = link;
                a.textContent = link.length > 50 ? link.substring(0, 50) + '...' : link;
                a.target = '_blank';
                a.title = link;
                dropdown.appendChild(a);
            });
            document.body.appendChild(dropdown);
            const rect = button.getBoundingClientRect();
            dropdown.style.left = `${rect.left + window.scrollX}px`;
            dropdown.style.top = `${rect.bottom + window.scrollY}px`;
        };
        window.onclick = function(event) {
            if (!event.target.matches('.dropbtn')) {
                document.querySelectorAll(".dropdown-content").forEach(content => content.classList.remove('show'));
            }
            const linksDropdown = document.getElementById('links-dropdown-container');
            if (linksDropdown && !linksDropdown.contains(event.target) && !event.target.matches('[data-links]')) {
                 linksDropdown.remove();
            }
        };

        window.fetchData = async () => {
            const tableBody = document.getElementById('taskListBody');
            tableBody.innerHTML = `<tr><td colspan="16">Đang tải dữ liệu...</td></tr>`;
            try {
                await ensureYearCollectionExists(currentYear);
                let html = '';
                let totalChildTasks = 0, totalPlannedCost = 0, totalExecutedCost = 0;
                let totalExecutedChildTasks = 0, totalExecutedLeafNodes = 0;
                let totalLeafNodes = 0;
                let totalLeafNodesCap1 = 0, totalExecutedLeafNodesCap1 = 0;
                let summaryByParent = {};

                const parentSnapshot = await getDocs(query(collection(db, getParentCollectionName())));
                const parents = parentSnapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                parents.sort((a, b) => a.id.localeCompare(b.id));

                for (const parentData of parents) {
                    let parentTotalChildTasks = 0, parentTotalPlannedCost = 0, parentTotalExecutedCost = 0;
                    let parentTotalExecutedChildTasks = 0, parentTotalExecutedLeafNodes = 0;
                    let parentTotalLeafNodes = 0;
                    let parentTotalLeafNodesCap1 = 0, parentTotalExecutedLeafNodesCap1 = 0;

                    const mainParentId = parentData.tt;

                    totalPlannedCost += parentData.chiPhi || 0;
                    parentTotalPlannedCost += parentData.chiPhi || 0;
                    totalExecutedCost += parentData.chiPhiThucHien || 0;
                    parentTotalExecutedCost += parentData.chiPhiThucHien || 0;
                    
                    const parentPath = `${getParentCollectionName()}/${parentData.id}`;
                    html += `<tr class="task-parent" data-main-parent="${mainParentId}"><td></td><td class="col-tt">${parentData.tt}</td><td class="col-noidung">${parentData.noiDung}</td><td class="col-dv-thuchien"></td><td class="col-donvi"></td><td class="col-soluong"></td><td class="col-tansuat-th"></td><td class="text-right col-cp-giaitrinh">${formatNumber(parentData.cpGiaiTrinh)}</td><td class="text-right col-chiphi">${formatNumber(parentData.chiPhi)}</td><td class="text-right col-chiphi-thuchien">${formatNumber(parentData.chiPhiThucHien)}</td><td class="text-right col-kehoach-conlai">${formatNumber(parentData.keHoachConLai)}</td><td class="col-capdo"></td><td class="text-right col-kh-nam-truoc">${formatNumber(parentData.khNamTruoc)}</td><td class="col-ghichu">${parentData.ghiChu || ''}</td><td class="col-hoso"></td><td class="col-action"><div class="dropdown"><button onclick="toggleDropdown(event)" class="btn-secondary btn-action dropbtn">Thêm/sửa</button><div class="dropdown-content"><a href="#" onclick="openAddModal('${parentPath}', 'child')">Thêm lĩnh vực ATCLMT</a><a href="#" onclick="handleEditClick('${parentPath}', 'parent')">Sửa Nội dung</a></div></div></td></tr>`;

                    const childSnapshot = await getDocs(query(collection(db, parentPath, "công việc con")));
                    const children = childSnapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                    children.sort(childSort);
                    for (const childData of children) {
                        totalChildTasks++;
                        parentTotalChildTasks++;
                        if (childData.daThucHien === true) {
                            totalExecutedChildTasks++;
                            parentTotalExecutedChildTasks++;
                        }
                        
                        const childPath = `${parentPath}/công việc con/${childData.id}`;
                         if (!childData.isHidden) {
                            html += `<tr class="task-child" data-main-parent="${mainParentId}"><td><input type="checkbox" class="parent-checkbox" data-path="${childPath}" onchange="toggleChildrenCheckboxes(this)"></td><td class="col-tt">${childData.tt}</td><td class="col-noidung">${childData.noiDung}</td><td class="col-dv-thuchien"></td><td class="col-donvi"></td><td class="col-soluong"></td><td class="col-tansuat-th"></td><td class="text-right col-cp-giaitrinh">${formatNumber(childData.cpGiaiTrinh)}</td><td class="text-right col-chiphi">${formatNumber(childData.chiPhi)}</td><td class="text-right col-chiphi-thuchien">${formatNumber(childData.chiPhiThucHien)}</td><td class="text-right col-kehoach-conlai">${formatNumber(childData.keHoachConLai)}</td><td class="col-capdo">${childData.capDo || ''}</td><td class="text-right col-kh-nam-truoc">${formatNumber(childData.khNamTruoc)}</td><td class="col-ghichu">${childData.ghiChu || ''}</td><td class="col-hoso"></td><td class="col-action"><div class="dropdown"><button onclick="toggleDropdown(event)" class="btn-secondary btn-action dropbtn">Thêm/sửa</button><div class="dropdown-content"><a href="#" onclick="openAddModal('${childPath}', 'grandchild')">Thêm mục công việc</a><a href="#" onclick="handleEditClick('${childPath}', 'child')">Sửa Nội dung</a></div></div></td></tr>`;
                        }

                        const grandchildSnapshot = await getDocs(query(collection(db, childPath, "công việc cháu")));
                        const grandchildren = grandchildSnapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                        grandchildren.sort((a, b) => parseInt(a.id, 10) - parseInt(b.id, 10));
                        for (const grandchildData of grandchildren) {
                            const grandchildPath = `${childPath}/công việc cháu/${grandchildData.id}`;
                            html += `<tr class="task-grandchild" data-main-parent="${mainParentId}"><td><input type="checkbox" class="parent-checkbox" data-path="${grandchildPath}" data-parent-path="${childPath}" onchange="toggleChildrenCheckboxes(this)"></td><td class="col-tt">${grandchildData.tt}</td><td class="col-noidung">${grandchildData.noiDung}</td><td class="col-dv-thuchien"></td><td class="col-donvi"></td><td class="col-soluong"></td><td class="col-tansuat-th"></td><td class="text-right col-cp-giaitrinh">${formatNumber(grandchildData.cpGiaiTrinh)}</td><td class="text-right col-chiphi">${formatNumber(grandchildData.chiPhi)}</td><td class="text-right col-chiphi-thuchien">${formatNumber(grandchildData.chiPhiThucHien)}</td><td class="text-right col-kehoach-conlai">${formatNumber(grandchildData.keHoachConLai)}</td><td class="col-capdo"></td><td class="text-right col-kh-nam-truoc">${formatNumber(grandchildData.khNamTruoc)}</td><td class="col-ghichu">${grandchildData.ghiChu || ''}</td><td class="col-hoso"></td><td class="col-action"><div class="dropdown"><button onclick="toggleDropdown(event)" class="btn-secondary btn-action dropbtn">Thêm/sửa</button><div class="dropdown-content"><a href="#" onclick="openAddModal('${grandchildPath}', 'greatGrandchild')">Thêm công việc chi tiết</a><a href="#" onclick="handleEditClick('${grandchildPath}', 'grandchild')">Sửa Nội dung</a></div></div></td></tr>`;

                            const greatGrandchildSnapshot = await getDocs(query(collection(db, grandchildPath, "công việc chắt")));
                            const greatGrandchildren = greatGrandchildSnapshot.docs.map(d => ({ id: d.id, ...d.data()}));
                            greatGrandchildren.sort(numericSort);
                            for (const greatGrandchildData of greatGrandchildren) {
                                const greatGrandchildPath = `${grandchildPath}/công việc chắt/${greatGrandchildData.id}`;
                                const isParentLeaf = greatGrandchildData.hasChildren;
                                const noiDungStyle = greatGrandchildData.chiPhiThucHien > 0 ? 'style="color: #5B77A8;"' : '';
                                const rowClass = `task-great-grandchild ${isParentLeaf ? 'is-parent-leaf' : ''}`;
                                const addJustificationLink = !isParentLeaf ? `<a href="#" onclick="openAddModal('${greatGrandchildPath}', 'justification')">Thêm giải trình</a>` : '';

                                html += `<tr class="${rowClass}" data-main-parent="${mainParentId}">
                                            <td><input type="checkbox" class="${isParentLeaf ? 'parent-checkbox' : 'task-checkbox'}" data-path="${greatGrandchildPath}" data-parent-path="${grandchildPath}" onchange="${isParentLeaf ? 'toggleChildrenCheckboxes(this)' : 'toggleSelection(this)'}"></td>
                                            <td class="col-tt">${greatGrandchildData.tt}</td><td class="col-noidung" ${noiDungStyle}>${greatGrandchildData.noiDung}</td>
                                            <td class="col-dv-thuchien">${greatGrandchildData.dvThucHien || ''}</td>
                                            <td class="col-donvi">${greatGrandchildData.donVi || ''}</td><td class="col-soluong">${greatGrandchildData.soLuong || ''}</td>
                                            <td class="col-tansuat-th">${greatGrandchildData.tanSuatTH || ''}</td>
                                            <td class="text-right col-cp-giaitrinh">${formatNumber(greatGrandchildData.cpGiaiTrinh)}</td>
                                            <td class="text-right col-chiphi">${formatNumber(greatGrandchildData.chiPhi)}</td>
                                            <td class="text-right col-chiphi-thuchien">${formatNumber(greatGrandchildData.chiPhiThucHien)}</td><td class="text-right col-kehoach-conlai">${formatNumber(greatGrandchildData.keHoachConLai)}</td>
                                            <td class="col-capdo">${greatGrandchildData.capDo || ''}</td>
                                            <td class="text-right col-kh-nam-truoc">${formatNumber(greatGrandchildData.khNamTruoc)}</td>
                                            <td class="col-ghichu">${greatGrandchildData.ghiChu || ''}</td><td class="col-hoso"></td>
                                            <td class="col-action">
                                                <div class="dropdown">
                                                    <button onclick="toggleDropdown(event)" class="btn-secondary btn-action dropbtn">Thêm/sửa</button>
                                                    <div class="dropdown-content">
                                                        <a href="#" onclick="openAddModal('${greatGrandchildPath}', 'greatGreatGrandchild')">Thêm công việc cụ thể</a>
                                                        ${addJustificationLink}
                                                        <a href="#" onclick="handleEditClick('${greatGrandchildPath}', 'greatGrandchild')">Sửa Nội dung</a>
                                                    </div>
                                                </div>
                                            </td>
                                         </tr>`;

                                if (isParentLeaf) {
                                     const greatGreatGrandchildSnapshot = await getDocs(query(collection(db, greatGrandchildPath, "công việc cụ thể")));
                                     const greatGreatGrandchildren = greatGreatGrandchildSnapshot.docs.map(d => ({id: d.id, ...d.data()}));
                                     greatGreatGrandchildren.sort(numericSort);
                                     for (const gggcData of greatGreatGrandchildren) {
                                        const gggcPath = `${greatGrandchildPath}/công việc cụ thể/${gggcData.id}`;
                                        const plannedCount = gggcData.tanSuatTH || 0;
                                        totalLeafNodes += plannedCount;
                                        parentTotalLeafNodes += plannedCount;
                                        const executedCount = Math.min(plannedCount, gggcData.chiPhiThucHien > 0 ? plannedCount : 0);
                                        totalExecutedLeafNodes += executedCount;
                                        parentTotalExecutedLeafNodes += executedCount;
                                        
                                        if (gggcData.capDo == 1) {
                                            totalLeafNodesCap1 += plannedCount;
                                            parentTotalLeafNodesCap1 += plannedCount;
                                            totalExecutedLeafNodesCap1 += executedCount;
                                            parentTotalExecutedLeafNodesCap1 += executedCount;
                                        }

                                        const gggcNoiDungStyle = gggcData.chiPhiThucHien > 0 ? 'style="color: #5B77A8;"' : '';
                                        html += `<tr class="task-great-great-grandchild" data-main-parent="${mainParentId}">
                                            <td><input type="checkbox" class="task-checkbox" data-path="${gggcPath}" data-parent-path="${greatGrandchildPath}" onchange="toggleSelection(this)"></td>
                                            <td class="col-tt">${gggcData.tt}</td><td class="col-noidung" ${gggcNoiDungStyle}>${gggcData.noiDung}</td>
                                            <td class="col-dv-thuchien">${gggcData.dvThucHien || ''}</td>
                                            <td class="col-donvi">${gggcData.donVi || ''}</td><td class="col-soluong">${gggcData.soLuong || ''}</td>
                                            <td class="col-tansuat-th">${gggcData.tanSuatTH || ''}</td>
                                            <td class="text-right col-cp-giaitrinh">${formatNumber(gggcData.cpGiaiTrinh)}</td>
                                            <td class="text-right col-chiphi">${formatNumber(gggcData.chiPhi)}</td>
                                            <td class="text-right col-chiphi-thuchien">${formatNumber(gggcData.chiPhiThucHien)}</td><td class="text-right col-kehoach-conlai">${formatNumber(gggcData.keHoachConLai)}</td>
                                            <td class="col-capdo">${gggcData.capDo || ''}</td>
                                            <td class="text-right col-kh-nam-truoc">${formatNumber(gggcData.khNamTruoc)}</td>
                                            <td class="col-ghichu">${gggcData.ghiChu || ''}</td><td class="col-hoso"></td>
                                            <td class="col-action">
                                                <div class="dropdown">
                                                    <button onclick="toggleDropdown(event)" class="btn-secondary btn-action dropbtn">Thêm/sửa</button>
                                                    <div class="dropdown-content">
                                                        <a href="#" onclick="openAddModal('${gggcPath}', 'justification')">Thêm giải trình</a>
                                                        <a href="#" onclick="handleEditClick('${gggcPath}', 'greatGreatGrandchild')">Sửa Nội dung</a>
                                                    </div>
                                                </div>
                                            </td>
                                         </tr>`;

                                        const justificationSnapshot = await getDocs(query(collection(db, gggcPath, "giải trình")));
                                        const justifications = justificationSnapshot.docs.map(d => ({ id: d.id, path: d.ref.path, ...d.data()})).sort((a,b) => a.id.localeCompare(b.id));
                                        for(const justData of justifications) {
                                            html += `<tr class="task-justification" data-main-parent="${mainParentId}">
                                                <td><input type="checkbox" class="justification-checkbox" data-path="${justData.path}" data-parent-path="${gggcPath}" onchange="toggleSelection(this)"></td>
                                                <td class="col-tt">${justData.tt}</td>
                                                <td class="col-noidung">${justData.noiDung}</td>
                                                <td class="col-dv-thuchien"></td>
                                                <td class="col-donvi">${justData.donVi || ''}</td>
                                                <td class="col-soluong">${justData.soLuong || ''}</td>
                                                <td class="col-tansuat-th"></td>
                                                <td class="text-right col-cp-giaitrinh">${formatNumber(justData.cpGiaiTrinh)}</td>
                                                <td class="text-right col-chiphi"></td>
                                                <td class="text-right col-chiphi-thuchien"></td>
                                                <td class="text-right col-kehoach-conlai"></td>
                                                <td class="col-capdo"></td>
                                                <td class="text-right col-kh-nam-truoc"></td>
                                                <td class="col-ghichu"></td>
                                                <td class="col-hoso"></td>
                                                <td class="col-action"><button class="btn-secondary btn-action btn-edit-leaf" onclick="handleEditClick('${justData.path}', 'justification')">Sửa</button></td>
                                            </tr>`;
                                        }
                                     }
                                } else {
                                     const plannedCount = greatGrandchildData.tanSuatTH || 0;
                                     totalLeafNodes += plannedCount;
                                     parentTotalLeafNodes += plannedCount;
                                     const executedCount = Math.min(plannedCount, greatGrandchildData.chiPhiThucHien > 0 ? plannedCount : 0);
                                     totalExecutedLeafNodes += executedCount;
                                     parentTotalExecutedLeafNodes += executedCount;

                                     if (greatGrandchildData.capDo == 1) {
                                         totalLeafNodesCap1 += plannedCount;
                                         parentTotalLeafNodesCap1 += plannedCount;
                                         totalExecutedLeafNodesCap1 += executedCount;
                                         parentTotalExecutedLeafNodesCap1 += executedCount;
                                     }

                                     const justificationSnapshot = await getDocs(query(collection(db, greatGrandchildPath, "giải trình")));
                                     const justifications = justificationSnapshot.docs.map(d => ({ id: d.id, path: d.ref.path, ...d.data()})).sort((a,b) => a.id.localeCompare(b.id));
                                     for(const justData of justifications) {
                                        html += `<tr class="task-justification" data-main-parent="${mainParentId}">
                                            <td><input type="checkbox" class="justification-checkbox" data-path="${justData.path}" data-parent-path="${greatGrandchildPath}" onchange="toggleSelection(this)"></td>
                                            <td class="col-tt">${justData.tt}</td>
                                            <td class="col-noidung">${justData.noiDung}</td>
                                            <td class="col-dv-thuchien"></td>
                                            <td class="col-donvi">${justData.donVi || ''}</td>
                                            <td class="col-soluong">${justData.soLuong || ''}</td>
                                            <td class="col-tansuat-th"></td>
                                            <td class="text-right col-cp-giaitrinh">${formatNumber(justData.cpGiaiTrinh)}</td>
                                            <td class="text-right col-chiphi"></td>
                                            <td class="text-right col-chiphi-thuchien"></td>
                                            <td class="text-right col-kehoach-conlai"></td>
                                            <td class="col-capdo"></td>
                                            <td class="text-right col-kh-nam-truoc"></td>
                                            <td class="col-ghichu"></td>
                                            <td class="col-hoso"></td>
                                            <td class="col-action"><button class="btn-secondary btn-action btn-edit-leaf" onclick="handleEditClick('${justData.path}', 'justification')">Sửa</button></td>
                                        </tr>`;
                                     }
                                }
                            }
                        }
                    }
                    summaryByParent[parentData.id] = {
                        totalChildTasks: parentTotalChildTasks,
                        totalExecutedChildTasks: parentTotalExecutedChildTasks,
                        totalPlannedCost: parentTotalPlannedCost,
                        totalExecutedCost: parentTotalExecutedCost,
                        totalLeafNodes: parentTotalLeafNodes,
                        totalExecutedLeafNodes: parentTotalExecutedLeafNodes,
                        totalLeafNodesCap1: parentTotalLeafNodesCap1,
                        totalExecutedLeafNodesCap1: parentTotalExecutedLeafNodesCap1,
                    };
                }
                tableBody.innerHTML = html || `<tr><td colspan="16">Không có dữ liệu cho năm ${currentYear}.</td></tr>`;

                const leafNodePercentage = totalLeafNodes > 0 ? Math.round((totalExecutedLeafNodes / totalLeafNodes) * 100) : 0;
                const costPercentage = totalPlannedCost > 0 ? Math.round((totalExecutedCost / totalPlannedCost) * 100) : 0;
                const cap1Percentage = totalLeafNodesCap1 > 0 ? Math.round((totalExecutedLeafNodesCap1 / totalLeafNodesCap1) * 100) : 0;
                
                const summaryHtml = `
                    <button class="btn-info" style="position: absolute; top: 10px; right: 10px; padding: 5px 10px; font-size: 14px;" onclick="openSummaryDetailModal()">Xem chi tiết các đơn vị</button>
                    <div class="summary-column">
                        <p><strong>Tổng số đầu việc chi tiết đã lên kế hoạch:</strong> ${totalLeafNodes}</p>
                        <p><strong>Tổng số đầu việc cấp độ 1 cần thực hiện:</strong> ${totalLeafNodesCap1}</p>
                        <p><strong>Tổng chi phí theo kế hoạch:</strong> ${formatNumber(totalPlannedCost)}</p>
                    </div>
                    <div class="summary-column">
                        <p><strong>Số đầu việc chi tiết đã thực hiện:</strong> ${totalExecutedLeafNodes} <span class="percentage">(${leafNodePercentage}%)</span></p>
                        <p><strong>Số đầu việc cấp độ 1 đã thực hiện:</strong> ${totalExecutedLeafNodesCap1} <span class="percentage">(${cap1Percentage}%)</span></p>
                        <p><strong>Tổng chi phí đã thực hiện:</strong> ${formatNumber(totalExecutedCost)} <span class="percentage">(${costPercentage}%)</span></p>
                    </div>`;
                document.getElementById('summarySection').innerHTML = summaryHtml;

                const overallSummary = {
                    totalChildTasks, totalExecutedChildTasks,
                    totalPlannedCost, totalExecutedCost,
                    totalLeafNodes, totalExecutedLeafNodes,
                    totalLeafNodesCap1, totalExecutedLeafNodesCap1
                };

                const finalSummaryData = {
                    overall: overallSummary,
                    ...summaryByParent
                };

                if(isAuthenticated) {
                   await setDoc(doc(db, 'summary_data', String(currentYear)), finalSummaryData);
                }

                selectedTasks.clear();
                selectedJustifications.clear();
                updateButtonStates();
                statusDiv.innerText = '';
            } catch (error) { console.error("Lỗi tải dữ liệu: ", error); tableBody.innerHTML = `<tr><td colspan="16">Lỗi tải dữ liệu: ${error.message}</td></tr>`; }
        };

        const planningPasswords = {
            'all': '2662', 'A': '8726', 'B': '8646', 'C': '8734',
            'D': '8663', 'E': '8853', 'F': '3822'
        };

        window.togglePlanningColumns = (isChecked) => {
            if (isChecked) {
                openPlanningModeModal();
            } else {
                const taskList = document.getElementById('taskList');
                planningModeByYear[currentYear] = false;
                taskList.classList.remove('planning-mode');
                document.getElementById('exportExcel1Btn').disabled = false;
                document.getElementById('exportExcel2Btn').disabled = true;
                const allRows = document.querySelectorAll('#taskListBody tr');
                allRows.forEach(row => row.style.display = '');
            }
        };

        function openPlanningModeModal() {
            const modal = document.getElementById('planningModeModal');
            const optionsContainer = document.getElementById('planningModeOptions');
            optionsContainer.innerHTML = ''; 

            const allButton = document.createElement('button');
            allButton.className = 'btn-primary';
            allButton.textContent = 'Tất cả dữ liệu';
            allButton.style.cssText = 'width: 100%; margin-bottom: 10px; text-align: left; padding: 12px;';
            allButton.onclick = () => promptForPlanningPassword('all', 'Tất cả dữ liệu');
            optionsContainer.appendChild(allButton);

            const parentRows = document.querySelectorAll('.task-parent');
            parentRows.forEach(row => {
                const tt = row.querySelector('.col-tt').textContent;
                const noiDung = row.querySelector('.col-noidung').textContent;
                const parentButton = document.createElement('button');
                parentButton.className = 'btn-secondary';
                parentButton.textContent = `${tt}. ${noiDung}`;
                parentButton.style.cssText = 'width: 100%; margin-bottom: 10px; text-align: left; padding: 12px;';
                parentButton.onclick = () => promptForPlanningPassword(tt, `${tt}. ${noiDung}`);
                optionsContainer.appendChild(parentButton);
            });

            modal.style.display = 'block';
        }

        window.promptForPlanningPassword = (selectionId, selectionText) => {
            const correctPassword = planningPasswords[selectionId];
            if (!correctPassword) {
                activatePlanningModeForSelection(selectionId);
                return;
            }

            const enteredPassword = prompt(`Vui lòng nhập mật khẩu để xem phạm vi:\n"${selectionText}"`);

            if (enteredPassword === null) {
                return; 
            }

            if (enteredPassword === correctPassword) {
                activatePlanningModeForSelection(selectionId);
            } else {
                alert('Mật khẩu không chính xác.');
            }
        };

        window.closePlanningModal = () => {
            document.getElementById('planningModeToggle').checked = false;
            document.getElementById('planningModeModal').style.display = 'none';
        }

        window.activatePlanningModeForSelection = (selectionId) => {
            const taskList = document.getElementById('taskList');
            planningModeByYear[currentYear] = true;

            taskList.classList.add('planning-mode');
            document.getElementById('exportExcel1Btn').disabled = true;
            document.getElementById('exportExcel2Btn').disabled = false;

            const allRows = document.querySelectorAll('#taskListBody tr');
            allRows.forEach(row => {
                if (selectionId === 'all' || row.dataset.mainParent === selectionId) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });

            document.getElementById('planningModeModal').style.display = 'none';
        };

        function getParentCollectionName() { return `công việc mẹ ${currentYear}`; }
        function initializeYearDropdown() {
            const yearSelect = document.getElementById('yearSelect');
            const currentYearValue = new Date().getFullYear();
            const nextYear = currentYearValue + 1;
            yearSelect.innerHTML = '';
            const years = [currentYearValue, nextYear];
            for (let i = currentYearValue - 1; i >= currentYearValue - 3; i--) {
                years.unshift(i);
            }
            years.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearSelect.appendChild(option);
            });
            currentYear = currentYearValue;
            yearSelect.value = currentYearValue;
        }
        window.changeYear = (year) => {
            currentYear = parseInt(year);
            fetchData();
            updateButtonStates();
            const toggle = document.getElementById('planningModeToggle');
            toggle.checked = planningModeByYear[currentYear] || false;
            if(!toggle.checked) {
                 togglePlanningColumns(false);
            }
        };
        async function ensureYearCollectionExists(year) {
            const collectionName = `công việc mẹ ${year}`;
            try {
                const testQuery = query(collection(db, collectionName), limit(1));
                const testSnapshot = await getDocs(testQuery);
                if (testSnapshot.empty) {
                    console.log(`Collection cho năm ${year} chưa tồn tại, sẽ được tạo khi có dữ liệu`);
                }
            } catch (error) {
                console.log(`Collection cho năm ${year} chưa tồn tại, sẽ được tạo khi có dữ liệu`);
            }
        }
        window.closeAllModals = () => {
            document.querySelectorAll('.modal').forEach(modal => modal.style.display = 'none');
            activeCharts.forEach(chart => chart.destroy());
            activeCharts = [];
            const toggleDiv = document.getElementById('editModeToggle');
            if (toggleDiv) {
                toggleDiv.style.display = 'none';
                document.getElementById('unlockButton').style.display = 'block';
            }
        };
        window.openDataManagementModal = () => document.getElementById('dataManagementModal').style.display = 'block';
        
        window.openSummaryDetailModal = async () => {
            try {
                statusDiv.className = 'success';
                statusDiv.innerText = 'Đang tải dữ liệu chi tiết...';

                const summaryDocRef = doc(db, 'summary_data', String(currentYear));
                const summaryDocSnap = await getDoc(summaryDocRef);

                if (!summaryDocSnap.exists()) {
                    throw new Error('Không tìm thấy dữ liệu tổng hợp. Vui lòng nhấn "Tải lại & Tính toán lại".');
                }
                const summaryData = summaryDocSnap.data();

                const parentQuery = query(collection(db, getParentCollectionName()));
                const parentSnapshot = await getDocs(parentQuery);
                const parents = parentSnapshot.docs.map(d => ({ id: d.id, ...d.data() })).sort((a, b) => a.id.localeCompare(b.id));

                const modal = document.getElementById('summaryDetailModal');
                const contentContainer = document.getElementById('summaryDetailContent');
                document.getElementById('summaryDetailYear').textContent = currentYear;
                contentContainer.innerHTML = '';

                let htmlContent = '';
                for (const parent of parents) {
                    const parentId = parent.id;
                    const parentSummary = summaryData[parentId] || {};

                    const name = parent.noiDung || 'Chưa có tên';
                    const totalLeafNodes = parentSummary.totalLeafNodes || 0;
                    const executedLeafNodes = parentSummary.totalExecutedLeafNodes || 0;
                    const totalLeafNodesCap1 = parentSummary.totalLeafNodesCap1 || 0;
                    const executedLeafNodesCap1 = parentSummary.totalExecutedLeafNodesCap1 || 0;
                    const plannedCost = parentSummary.totalPlannedCost || 0;
                    const executedCost = parentSummary.totalExecutedCost || 0;

                    const leafPercentage = totalLeafNodes > 0 ? Math.round((executedLeafNodes / totalLeafNodes) * 100) : 0;
                    const cap1Percentage = totalLeafNodesCap1 > 0 ? Math.round((executedLeafNodesCap1 / totalLeafNodesCap1) * 100) : 0;
                    const costPercentage = plannedCost > 0 ? Math.round((executedCost / plannedCost) * 100) : 0;

                    htmlContent += `
                        <div class="summary-parent-card">
                            <h3>${parentId}. ${name}</h3>
                            <div class="summary-columns-container">
                                <div class="summary-info-column">
                                    <h4>Kế hoạch</h4>
                                    <p><strong>Số đầu việc KH:</strong> <span class="value">${totalLeafNodes}</span></p>
                                    <p><strong>Số ĐV cấp 1:</strong> <span class="value">${totalLeafNodesCap1}</span></p>
                                    <p><strong>Chi phí KH:</strong> <span class="value">${formatNumber(plannedCost)}</span></p>
                                </div>
                                <div class="summary-info-column">
                                    <h4>Thực hiện</h4>
                                    <p><strong>Số đầu việc TH:</strong> <span class="value">${executedLeafNodes} <span class="percentage">(${leafPercentage}%)</span></span></p>
                                    <p><strong>Số ĐV cấp 1 TH:</strong> <span class="value">${executedLeafNodesCap1} <span class="percentage">(${cap1Percentage}%)</span></span></p>
                                    <p><strong>Chi phí TH:</strong> <span class="value">${formatNumber(executedCost)} <span class="percentage">(${costPercentage}%)</span></span></p>
                                </div>
                            </div>
                            <div class="summary-charts-container">
                                <div class="chart-wrapper">
                                    <canvas id="cap1Chart-${parentId}"></canvas>
                                    <p>Tỷ lệ ĐV Cấp 1</p>
                                </div>
                                <div class="chart-wrapper">
                                    <canvas id="costChart-${parentId}"></canvas>
                                    <p>Tỷ lệ Chi phí</p>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                contentContainer.innerHTML = htmlContent || '<p>Không có dữ liệu chi tiết để hiển thị.</p>';
                modal.style.display = 'block';

                // Now, render the charts
                activeCharts.forEach(chart => chart.destroy());
                activeCharts = [];

                for (const parent of parents) {
                    const parentId = parent.id;
                    const parentSummary = summaryData[parentId] || {};

                    const totalLeafNodesCap1 = parentSummary.totalLeafNodesCap1 || 0;
                    const executedLeafNodesCap1 = parentSummary.totalExecutedLeafNodesCap1 || 0;
                    const plannedCost = parentSummary.totalPlannedCost || 0;
                    const executedCost = parentSummary.totalExecutedCost || 0;

                    // Chart 1: Cap 1 Task Completion
                    const cap1Ctx = document.getElementById(`cap1Chart-${parentId}`).getContext('2d');
                    const cap1Chart = new Chart(cap1Ctx, {
                        type: 'doughnut',
                        data: {
                            labels: ['Đã thực hiện', 'Chưa thực hiện'],
                            datasets: [{
                                data: [executedLeafNodesCap1, totalLeafNodesCap1 - executedLeafNodesCap1],
                                backgroundColor: ['#28a745', '#e9ecef'],
                                borderColor: ['#28a745', '#e9ecef'],
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: { display: false },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            let label = context.label || '';
                                            if (label) { label += ': '; }
                                            if (context.parsed !== null) {
                                                label += context.parsed + ' đầu việc';
                                            }
                                            return label;
                                        }
                                    }
                                }
                            }
                        }
                    });
                    activeCharts.push(cap1Chart);

                    // Chart 2: Cost Execution
                    const costCtx = document.getElementById(`costChart-${parentId}`).getContext('2d');
                     const costChart = new Chart(costCtx, {
                        type: 'doughnut',
                        data: {
                            labels: ['Đã thực hiện', 'Còn lại'],
                            datasets: [{
                                data: [executedCost, plannedCost > executedCost ? plannedCost - executedCost : 0],
                                backgroundColor: ['#007bff', '#e9ecef'],
                                borderColor: ['#007bff', '#e9ecef'],
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: { display: false },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            let label = context.label || '';
                                            if (label) { label += ': '; }
                                            if (context.parsed !== null) {
                                                label += formatNumber(context.parsed);
                                            }
                                            return label;
                                        }
                                    }
                                }
                            }
                        }
                    });
                    activeCharts.push(costChart);
                }

                statusDiv.innerText = '';
            } catch (error) {
                console.error("Lỗi khi mở modal chi tiết:", error);
                statusDiv.className = 'error';
                statusDiv.innerText = `Lỗi: ${error.message}`;
            }
        };

        const createModalTable = (headers) => {
            let table = '<table class="modal-table"><thead><tr>';
            headers.forEach(h => {
                const style = h.width ? ` style="width: ${h.width};"` : '';
                const className = h.class ? ` class="${h.class}"` : '';
                const text = typeof h === 'object' ? h.text : h;
                table += `<th${style}${className}>${text}</th>`;
            });
            table += '</tr></thead><tbody>';
            return table;
        };
        const createInputRow = (path, data, level) => {
            const isJustification = level === 'justification';
            if (isJustification) {
                return `<tr data-path="${path}">
                    <td><input type="text" value="${data.tt || ''}" disabled></td>
                    <td><input type="text" value="${data.noiDung || ''}" data-field="noiDung"></td>
                    <td><input type="text" value="${data.donVi || ''}" data-field="donVi"></td>
                    <td><input type="text" value="${data.soLuong || ''}" data-field="soLuong"></td>
                    <td><input type="text" value="${formatNumber(data.cpGiaiTrinh || 0)}" data-field="cpGiaiTrinh" oninput="this.value=formatNumber(parseNumber(this.value))" onfocus="this.select()"></td>
                </tr>`;
            }

            const isParent = ['parent', 'child', 'grandchild'].includes(level);
            const isContainerLeaf = level === 'greatGrandchild' && data.hasChildren;
            const isEditableLeaf = level === 'greatGreatGrandchild' || (level === 'greatGrandchild' && !data.hasChildren);

            const isDisabled = (field) => {
                if (field === 'tt') return true;
                if (isParent) return !['noiDung', 'ghiChu'].includes(field);
                if (isContainerLeaf) return !['noiDung', 'ghiChu', 'capDo', 'dvThucHien'].includes(field);
                return false;
            };

            const chiPhiEvent = isEditableLeaf ? 'onfocus="this.select()"' : '';
            return `<tr data-path="${path}">
                        <td><input type="text" value="${data.tt || ''}" disabled></td>
                        <td><input type="text" value="${data.noiDung || ''}" data-field="noiDung" ${isDisabled('noiDung') ? 'disabled' : ''}></td>
                        <td><input type="text" value="${data.dvThucHien || ''}" data-field="dvThucHien" ${isDisabled('dvThucHien') ? 'disabled' : ''}></td>
                        <td><input type="text" value="${data.donVi || ''}" data-field="donVi" ${isDisabled('donVi') ? 'disabled' : ''}></td>
                        <td><input type="text" value="${data.soLuong || ''}" data-field="soLuong" ${isDisabled('soLuong') ? 'disabled' : ''}></td>
                        <td><input type="number" value="${data.tanSuatTH || ''}" data-field="tanSuatTH" ${isDisabled('tanSuatTH') ? 'disabled' : ''}></td>
                        <td><input type="text" value="${formatNumber(data.cpGiaiTrinh || 0)}" data-field="cpGiaiTrinh" disabled></td>
                        <td><input type="text" value="${formatNumber(data.chiPhi || 0)}" data-field="chiPhi" oninput="this.value=formatNumber(parseNumber(this.value))" ${chiPhiEvent} ${isDisabled('chiPhi') ? 'disabled' : ''}></td>
                        <td><input type="text" value="${formatNumber(data.khNamTruoc || 0)}" data-field="khNamTruoc" oninput="this.value=formatNumber(parseNumber(this.value))" ${chiPhiEvent} ${isDisabled('khNamTruoc') ? 'disabled' : ''}></td>
                        <td><input type="text" value="${data.capDo || ''}" data-field="capDo" ${isDisabled('capDo') ? 'disabled' : ''}></td>
                        <td><input type="text" value="${data.ghiChu || ''}" data-field="ghiChu" ${isDisabled('ghiChu') ? 'disabled' : ''}></td>
                    </tr>`;
        };
        window.handleEditClick = async (docPath, level) => {
            const allSelected = [...selectedTasks, ...selectedJustifications];
            const isMultiSelect = allSelected.some(p => p === docPath) && allSelected.length > 1;

            let pathsToEdit = isMultiSelect ? allSelected.sort() : [docPath];
            let title = isMultiSelect ? `Sửa ${pathsToEdit.length} mục đã chọn` : 'Sửa thông tin';
            document.getElementById('modalTitle').innerHTML = `<h2>${title}</h2>`;

            const isJustification = level === 'justification' || (pathsToEdit[0] && pathsToEdit[0].includes('giải trình'));
            const headers = isJustification
                ? [ {text: 'TT', width: '5%'}, 'Nội dung', {text: 'Đ.vị tính', width: '15%'}, {text: 'Số lượng', width: '15%'}, {text: 'CP Giải trình', width: '20%'}]
                : [ 'TT', 'Nội dung', 'ĐV th.hiện', 'Đ.vị tính', 'Số lượng', 'Tần suất TH', 'CP giải trình', 'Chi phí', 'KH năm trước', 'Cấp độ', 'Ghi chú' ];

            let table = createModalTable(headers);
            for (const path of pathsToEdit) {
                const currentIsJustification = path.includes('giải trình');
                if (isMultiSelect && currentIsJustification !== isJustification) continue;

                const docSnap = await getDoc(doc(db, path));
                if (docSnap.exists()) {
                    const currentLevel = path.includes('giải trình') ? 'justification' : path.includes('cụ thể') ? 'greatGreatGrandchild' : path.includes('chắt') ? 'greatGrandchild' : path.includes('cháu') ? 'grandchild' : path.includes('con') ? 'child' : 'parent';
                     table += createInputRow(path, docSnap.data(), currentLevel);
                }
            }
            table += '</tbody></table>';
            let modalBodyHTML = '';
            if (isJustification || (isMultiSelect && pathsToEdit[0].includes('giải trình'))) {
                 modalBodyHTML += '<div class="modal-note">Nhập chi phí giải trình vào ô "CP Giải trình".</div>';
            }
            else if (level === 'greatGrandchild' || level === 'greatGreatGrandchild') {
                modalBodyHTML += '<div class="modal-note">Lưu ý: Khi sửa giá trị chi phí, hãy nhập dải số liền, không có ký tự phân tách hàng nghìn. Ví dụ nhập: 2513000</div>';
            }
            modalBodyHTML += table;
            document.getElementById('modalBody').innerHTML = modalBodyHTML;
            document.getElementById('modalSaveButton').onclick = saveTasks;
            document.getElementById('modal-footer-left').innerHTML = '';
            document.getElementById('modalSaveButton').style.display = 'block';
            document.getElementById('modalDeleteButton').style.display = 'none';
            document.getElementById('dataModal').style.display = 'block';
        };
        window.openAddModal = async (parentPath, level) => {
            const titles = { child: 'Thêm Lĩnh vực AT-CL-MT vào bảng', grandchild: 'Thêm mục công việc', greatGrandchild: 'Thêm công việc chi tiết', greatGreatGrandchild: 'Thêm công việc cụ thể', justification: 'Thêm giải trình' };
            document.getElementById('modalTitle').innerHTML = `<h2>${titles[level]}</h2>`;

            const subCollectionNames = { child: 'công việc con', grandchild: 'công việc cháu', greatGrandchild: 'công việc chắt', greatGreatGrandchild: 'công việc cụ thể', justification: 'giải trình' };
            const subCollectionName = subCollectionNames[level];

            const snapshot = await getDocs(query(collection(db, parentPath, subCollectionName)));
            const existingIds = snapshot.docs.map(d => d.id);
            let newTT;

            if (level === 'justification') {
                const charCodes = existingIds.map(id => id.charCodeAt(0));
                const maxCharCode = Math.max(96, ...charCodes);
                newTT = String.fromCharCode(maxCharCode + 1);
            } else if (level === 'child') {
                const parentTT = parentPath.split('/').pop();
                const maxSubId = existingIds.map(id => parseInt(id.split('.')[1] || 0)).reduce((max, num) => Math.max(max, num), 0);
                newTT = `${parentTT}.${maxSubId + 1}`;
            } else if (level === 'grandchild') {
                const maxId = existingIds.map(id => parseInt(id, 10)).reduce((max, num) => Math.max(max, num), 0);
                newTT = String(maxId + 1);
            } else { 
                const parentTT = parentPath.split('/').pop();
                const maxSubId = existingIds.map(id => parseInt(id.split('.').pop() || 0)).reduce((max, num) => Math.max(max, num), 0);
                newTT = `${parentTT}.${maxSubId + 1}`;
            }

            const isJustification = level === 'justification';
            const headers = isJustification
                ? [ {text: 'TT', width: '5%'}, 'Nội dung', {text: 'Đ.vị tính', width: '15%'}, {text: 'Số lượng', width: '15%'}, {text: 'CP Giải trình', width: '20%'}]
                : [ 'TT', 'Nội dung', 'ĐV th.hiện', 'Đ.vị tính', 'Số lượng', 'Tần suất TH', 'CP giải trình', 'Chi phí', 'KH năm trước', 'Cấp độ', 'Ghi chú' ];

            let table = createModalTable(headers);
            table += createInputRow(parentPath, { tt: newTT }, level);
            table += '</tbody></table>';
            let modalBodyHTML = '';
            if (isJustification) {
                 modalBodyHTML += '<div class="modal-note">Nhập chi phí giải trình vào ô "CP Giải trình".</div>';
            }
            else if (level === 'greatGrandchild' || level === 'greatGreatGrandchild') {
                modalBodyHTML += '<div class="modal-note">Lưu ý: Khi nhập giá trị chi phí, hãy nhập dải số liền, không có ký tự phân tách hàng nghìn. Ví dụ nhập: 3621000</div>';
            }
            modalBodyHTML += table;
            document.getElementById('modalBody').innerHTML = modalBodyHTML;
            document.getElementById('modalSaveButton').onclick = () => addNewTask(parentPath, level, newTT);
            document.getElementById('modal-footer-left').innerHTML = '';
            document.getElementById('modalSaveButton').style.display = 'block';
            document.getElementById('modalDeleteButton').style.display = 'none';
            document.getElementById('dataModal').style.display = 'block';
        };
        const recalculateJustificationCostForParents = async(paths) => {
            const uniqueParentPaths = new Set(paths);
            for(const parentPath of uniqueParentPaths) {
                await recalculateSingleParentJustificationCost(parentPath);
            }
        };
        const recalculateSingleParentJustificationCost = async (parentPath) => {
            const snapshot = await getDocs(query(collection(db, parentPath, 'giải trình')));
            const totalCpGiaiTrinh = snapshot.docs.reduce((sum, doc) => sum + (doc.data().cpGiaiTrinh || 0), 0);
            await updateDoc(doc(db, parentPath), { cpGiaiTrinh: totalCpGiaiTrinh });
        }
        const recalculateCostsForParents = async (paths) => {
            const uniquePaths = new Set();
            paths.forEach(p => {
                const parts = p.split('/');
                 if (parts.length >= 10) { 
                    uniquePaths.add(JSON.stringify({
                        gggc: parts.slice(0, 8).join('/'),
                        gc: parts.slice(0, 6).join('/'),
                        c: parts.slice(0, 4).join('/'),
                        p: parts.slice(0, 2).join('/'),
                    }));
                } else if (parts.length >= 8) { 
                    uniquePaths.add(JSON.stringify({
                        gc: parts.slice(0, 6).join('/'),
                        c: parts.slice(0, 4).join('/'),
                        p: parts.slice(0, 2).join('/'),
                    }));
                }
            });

            const fieldsToRecalculate = ['chiPhi', 'chiPhiThucHien', 'cpGiaiTrinh', 'khNamTruoc'];
            for (const pathStr of uniquePaths) {
                const { gggc, gc, c, p } = JSON.parse(pathStr);
                if (gggc) await recalculateSingleParentCost(gggc, 'công việc cụ thể', fieldsToRecalculate);
                await recalculateSingleParentCost(gc, 'công việc chắt', fieldsToRecalculate);
                await recalculateSingleParentCost(c, 'công việc cháu', fieldsToRecalculate);
                await recalculateSingleParentCost(p, 'công việc con', fieldsToRecalculate);
            }
        };
        async function checkAndUpdateDaThucHien(childPath) {
            let hasHoSoLink = false;
            const grandchildSnapshot = await getDocs(query(collection(db, childPath, "công việc cháu")));
            for (const grandchildDoc of grandchildSnapshot.docs) {
                const greatGrandchildSnapshot = await getDocs(query(collection(grandchildDoc.ref, "công việc chắt")));
                 for (const greatGrandchildDoc of greatGrandchildSnapshot.docs) {
                    const greatGreatGrandchildSnapshot = await getDocs(query(collection(greatGrandchildDoc.ref, "công việc cụ thể")));
                    for (const greatGreatGrandchildDoc of greatGreatGrandchildSnapshot.docs) {
                        const execSnapshot = await getDocs(query(collection(greatGreatGrandchildDoc.ref, "thực hiện"), limit(1)));
                        if (!execSnapshot.empty && execSnapshot.docs[0].data().hoSoLink) { hasHoSoLink = true; break; }
                    }
                    if (hasHoSoLink) break;

                    const execSnapshot = await getDocs(query(collection(greatGrandchildDoc.ref, "thực hiện"), limit(1)));
                    if (!execSnapshot.empty && execSnapshot.docs[0].data().hoSoLink) { hasHoSoLink = true; break; }
                }
                if (hasHoSoLink) break;
            }
            const childDoc = await getDoc(doc(db, childPath));
            const chiPhiThucHien = childDoc.exists() ? (childDoc.data().chiPhiThucHien || 0) : 0;
            const daThucHien = (chiPhiThucHien > 0) || hasHoSoLink;
            await updateDoc(doc(db, childPath), { daThucHien: daThucHien });
        }
        const recalculateSingleParentCost = async (parentPath, subCollectionName, fieldsToSum) => {
            const parentDocRef = doc(db, parentPath);
            const parentSnap = await getDoc(parentDocRef);
            if (parentSnap.exists() && parentSnap.data().hasChildren && subCollectionName !== 'công việc cụ thể') {
            }

            const snapshot = await getDocs(query(collection(db, parentPath, subCollectionName)));
            const dataToUpdate = {};
            fieldsToSum.forEach(field => dataToUpdate[field] = 0);

            snapshot.docs.forEach(d => {
                 fieldsToSum.forEach(field => { dataToUpdate[field] += (d.data()[field] || 0); });
            });

            dataToUpdate.keHoachConLai = (dataToUpdate.chiPhi || 0) - (dataToUpdate.chiPhiThucHien || 0);
            await updateDoc(parentDocRef, dataToUpdate);
        };
        window.calculateThanhTien = (input) => {
            const row = input.closest('tr');
            const dvt = parseNumber(row.querySelector('input[data-field="dvt"]').value);
            const donGia = parseNumber(row.querySelector('input[data-field="donGia"]').value);
            const thanhTien = dvt * donGia;
            row.querySelector('input[data-field="thanhTien"]').value = formatNumber(thanhTien);
        };
        const setupInputNavigation = (tableSelector) => {
            const inputs = document.querySelectorAll(`${tableSelector} input[type="number"]`);
            inputs.forEach(input => {
                input.addEventListener('keydown', (e) => {
                    const cell = e.target.closest('td');
                    if (!cell) return;
                    const row = cell.closest('tr');
                    const cellIndex = Array.from(row.children).indexOf(cell);
                    const allRows = Array.from(row.parentElement.children);
                    const rowIndex = allRows.indexOf(row);
                    let targetRow, targetCell, targetInput;
                    const focusOnTarget = (selector) => {
                        if (targetCell) {
                           targetInput = targetCell.querySelector(selector);
                           if (targetInput) {
                                e.preventDefault();
                                targetInput.focus();
                                targetInput.select();
                           }
                        }
                    };
                    switch (e.key) {
                        case 'Enter':
                        case 'ArrowDown':
                            targetRow = allRows[rowIndex + 1];
                            if (targetRow) {
                                targetCell = targetRow.children[cellIndex];
                                focusOnTarget('input[type="number"]');
                            } else {
                                e.preventDefault();
                            }
                            break;
                        case 'ArrowUp':
                            targetRow = allRows[rowIndex - 1];
                            if (targetRow) {
                                targetCell = targetRow.children[cellIndex];
                                focusOnTarget('input[type="number"]');
                            }
                            break;
                        case 'ArrowLeft':
                             targetCell = row.children[cellIndex - 1];
                             focusOnTarget('input[type="number"]');
                             break;
                        case 'ArrowRight':
                             targetCell = row.children[cellIndex + 1];
                             focusOnTarget('input[type="number"]');
                             break;
                    }
                });
            });
        };
        window.openMultiExecutionModal = async () => {
            const selectedPaths = Array.from(selectedTasks);
            if (selectedPaths.length === 0) { alert("Vui lòng chọn ít nhất một công việc để thực hiện."); return; }
            document.getElementById('modalTitle').innerHTML = `<h2>Thực hiện ${selectedPaths.length} công việc</h2>`;
            const headers = [
                {text: 'Tiểu mục', class: 'col-tt'}, {text: 'Nội dung', class: 'col-noidung'},
                {text: 'Số lượng', class: 'col-dvt'}, {text: 'Đơn giá', class: 'col-dongia'},
                {text: 'Thành tiền', class: 'col-thanhtien'}
            ];
            let modalBodyHTML = `<div style="margin-bottom: 15px; display: flex; align-items: center; gap: 10px;"><label for="executionDate" style="font-weight: bold;">Ngày thực hiện:</label><input type="date" id="executionDate" style="padding: 5px; border: 1px solid #ccc; border-radius: 4px;" value="${new Date().toISOString().split('T')[0]}"></div>`;

            let table = `<table class="modal-table execution-modal-table"><thead><tr>`;
            headers.forEach(h => {
                table += `<th class="${h.class || ''}">${h.text}</th>`;
            });
            table += `</tr></thead><tbody>`;

            for (const path of selectedPaths) {
                const docSnap = await getDoc(doc(db, path));
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    table += `<tr data-path="${path}" data-tt="${data.tt}">
                                <td><input type="text" value="${data.tt}" disabled></td>
                                <td><input type="text" value="${data.noiDung}" disabled></td>
                                <td><input type="number" data-field="dvt" oninput="calculateThanhTien(this)"></td>
                                <td><input type="number" data-field="donGia" oninput="calculateThanhTien(this)"></td>
                                <td><input type="text" data-field="thanhTien" value="0" disabled></td>
                              </tr>`;
                }
            }
            table += '</tbody></table>';
            modalBodyHTML += table;
            modalBodyHTML += `<div class="modal-note">Mẹo: Sử dụng phím Enter hoặc các phím mũi tên (↑, ↓) để di chuyển nhanh giữa các ô nhập liệu.</div>`;
            const footerLeftHTML = `<div style="display: flex; flex-direction: column; align-items: flex-start;">
                                      <div style="display: flex; gap: 10px;">
                                        <button class="btn-success" onclick="exportExecutionTemplate()">Xuất Excel (Mẫu)</button>
                                        <button class="btn-warning" onclick="document.getElementById('importExecFile').click()">Nhập từ Excel</button>
                                        <input type="file" id="importExecFile" onchange="importExecutionData(event)" style="display: none;" accept=".xlsx, .xls">
                                      </div>
                                      <small style="margin-top: 5px;"><i>Ghi chú: Số liệu trong file excel nhập vào phải có định dạng general (không có ký hiệu hàng nghìn).</i></small>
                                    </div>`;
            document.getElementById('modal-footer-left').innerHTML = footerLeftHTML;
            document.getElementById('modalBody').innerHTML = modalBodyHTML;
            document.getElementById('modalSaveButton').onclick = saveMultiExecutionData;
            document.getElementById('modalSaveButton').style.display = 'block';
            document.getElementById('modalDeleteButton').style.display = 'none';
            document.getElementById('dataModal').style.display = 'block';
            setupInputNavigation('#dataModal .modal-table');
        };
        window.exportExecutionTemplate = () => {
            const rows = [['Tiểu mục', 'Nội dung', 'Số lượng', 'Đơn giá']];
            document.querySelectorAll('#dataModal .modal-table tbody tr').forEach(row => {
                const tt = row.querySelector('td:nth-child(1) input').value;
                const noiDung = row.querySelector('td:nth-child(2) input').value;
                rows.push([tt, noiDung, '', '']);
            });
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(rows);
            ws['!cols'] = [ { wch: 10 }, { wch: 60 }, { wch: 15 }, { wch: 15 } ];
            XLSX.utils.book_append_sheet(wb, ws, 'Mẫu nhập liệu');
            XLSX.writeFile(wb, `MauNhapLieuThucHien_${currentYear}.xlsx`);
        };
        window.importExecutionData = (event) => {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const workbook = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
                    const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                    jsonData.forEach(excelRow => {
                        const tt = String(excelRow['Tiểu mục'] || '').trim();
                        if (!tt) return;
                        const modalRow = document.querySelector(`#dataModal .modal-table tbody tr[data-tt="${tt}"]`);
                        if (modalRow) {
                            const soLuongInput = modalRow.querySelector('input[data-field="dvt"]');
                            const donGiaInput = modalRow.querySelector('input[data-field="donGia"]');
                            if (excelRow['Số lượng'] !== undefined) soLuongInput.value = excelRow['Số lượng'];
                            if (excelRow['Đơn giá'] !== undefined) donGiaInput.value = excelRow['Đơn giá'];
                            calculateThanhTien(soLuongInput);
                        }
                    });
                     statusDiv.className = 'success'; statusDiv.innerText = `Đã nhập dữ liệu từ file Excel vào biểu mẫu.`;
                } catch (error) {
                    console.error("Lỗi khi nhập Excel:", error);
                    statusDiv.className = 'error'; statusDiv.innerText = `Lỗi đọc file Excel: ${error.message}`;
                } finally {
                    event.target.value = '';
                }
            };
            reader.readAsArrayBuffer(file);
        };
        window.openSearchModal = async () => {
            statusDiv.className = 'success'; statusDiv.innerText = "Đang tìm kiếm dữ liệu thực hiện...";
            const q = query(collectionGroup(db, 'thực hiện'));
            const querySnapshot = await getDocs(q);
            executionGroups.clear();
            const uniqueLeafNodePaths = new Set();
            const uniqueChildPaths = new Set();
            querySnapshot.forEach(docSnap => {
                if (docSnap.ref.path.includes(getParentCollectionName())) {
                    const data = docSnap.data();
                    const pathParts = docSnap.ref.path.split('/');
                    const parentLeafNodePath = docSnap.ref.parent.parent.path;
                    const parentChildPath = pathParts.slice(0, 4).join('/');
                    uniqueLeafNodePaths.add(parentLeafNodePath);
                    uniqueChildPaths.add(parentChildPath);
                    const executionData = { ...data, path: docSnap.ref.path, parentLeafNodePath, parentChildPath };
                    let timestampKey;
                    if (data.timestamp && typeof data.timestamp.toMillis === 'function') {
                        timestampKey = data.timestamp.toMillis();
                    } else if (data.timestamp) {
                        timestampKey = data.timestamp;
                    } else {
                        timestampKey = `fallback_${data.ngayThucHien}_${Math.random()}`;
                    }
                    if (!executionGroups.has(timestampKey)) executionGroups.set(timestampKey, {});
                    const group = executionGroups.get(timestampKey);
                    if (!group[parentChildPath]) group[parentChildPath] = [];
                    group[parentChildPath].push(executionData);
                }
            });
            docDataMap.clear();
            const pathsToFetch = [...uniqueLeafNodePaths, ...uniqueChildPaths];
            const fetchPromises = Array.from(new Set(pathsToFetch)).map(path => getDoc(doc(db, path)));
            const allDocs = await Promise.all(fetchPromises);
            allDocs.forEach(docSnap => {
                if (docSnap.exists()) {
                    docDataMap.set(docSnap.ref.path, docSnap.data());
                }
            });
            statusDiv.innerText = "";
            let modalHeader = `<div style="display: flex; justify-content: space-between; align-items: center;">
                                <h2>Tra cứu các lần thực hiện công việc</h2>
                                <button class="btn-success" onclick="exportAllExecutionsToExcel()" style="margin-right: 20px;">Xuất toàn bộ ra Excel</button>
                               </div>`;
            document.getElementById('modalTitle').innerHTML = modalHeader;
            let table = `<table class="modal-table responsive-modal-table search-modal-mobile"><thead><tr><th style="width: 5%;">STT</th><th style="width: 10%;">Ngày T.Hiện</th><th style="width: 45%;">Trích yếu</th><th style="width: 15%; text-align:right;">Tổng chi phí</th><th style="width: 8%;">Số CV</th><th style="width: 15%;">Hành động</th></tr></thead><tbody>`;
            if (querySnapshot.empty) {
                 table += `<tr><td colspan="6">Không tìm thấy lần thực hiện nào.</td></tr>`;
            } else {
                const sortedGroups = Array.from(executionGroups.entries()).sort((a, b) => {
                    const dateA = a[1][Object.keys(a[1])[0]][0].ngayThucHien || '';
                    const dateB = b[1][Object.keys(b[1])[0]][0].ngayThucHien || '';
                    return dateB.localeCompare(dateA);
                });
                let counter = 1;
                for (const [timestampKey, group] of sortedGroups) {
                    let totalCost = 0; let summaryHtml = ''; let leafNodeCount = 0;
                    let hasHoSoLink = false;
                    for (const childPath in group) {
                        for (const item of group[childPath]) { if (item.hoSoLink) { hasHoSoLink = true; break; } }
                        if (hasHoSoLink) break;
                    }
                    for (const childPath in group) {
                        const childName = (docDataMap.get(childPath) || {}).noiDung || 'Công việc con không xác định';
                        summaryHtml += `<div><strong>${childName}</strong></div>`;
                        const leafNodeSummaries = group[childPath].map(item => {
                            totalCost += item.thanhTien; leafNodeCount++;
                            const noiDung = (docDataMap.get(item.parentLeafNodePath) || {}).noiDung || '';
                            return noiDung.length > 20 ? noiDung.substring(0, 20) + '...' : noiDung;
                        }).join('; ');
                        summaryHtml += `<div style="padding-left: 15px;">${leafNodeSummaries}</div>`;
                    }
                    const keyParam = typeof timestampKey === 'number' ? timestampKey : `'${timestampKey}'`;
                    const profileButtonClass = hasHoSoLink ? 'btn-danger' : 'btn-info';
                    const profileButtonText = hasHoSoLink ? 'Thay hồ sơ' : 'Nhập hồ sơ';
                    table += `<tr>
                        <td data-label="STT">${counter++}</td>
                        <td data-label="Ngày T.Hiện">${group[Object.keys(group)[0]][0].ngayThucHien}</td>
                        <td data-label="Trích yếu" style="line-height: 1.4;">${summaryHtml}</td>
                        <td data-label="Tổng chi phí" class="text-right">${formatNumber(totalCost)}</td>
                        <td data-label="Số CV">${leafNodeCount}</td>
                        <td data-label="Hành động">
                            <button class="btn-secondary btn-action btn-edit-exec" onclick="openExecutionEditModal(${keyParam})">Sửa</button>
                            <button class="${profileButtonClass} btn-action btn-profile-exec" onclick="handleProfileUploadClick(${keyParam})">${profileButtonText}</button>
                        </td>
                    </tr>`;
                }
            }
            table += '</tbody></table>';
            document.getElementById('modalBody').innerHTML = table;
            document.getElementById('modal-footer-left').innerHTML = '';
            document.getElementById('modalSaveButton').style.display = 'none';
            document.getElementById('modalDeleteButton').style.display = 'none';
            document.getElementById('dataModal').style.display = 'block';
        };
        window.exportAllExecutionsToExcel = async () => {
            if (executionGroups.size === 0) { alert("Không có dữ liệu thực hiện để xuất."); return; }
            try {
                statusDiv.className = 'success'; statusDiv.innerText = "Đang chuẩn bị dữ liệu Excel...";
                const rows = [['STT', 'Ngày Thực Hiện', 'Lĩnh vực ATCLMT', 'Tiểu mục', 'Nội dung Công việc', 'Số lượng', 'Đơn giá', 'Thành tiền', 'Kế hoạch còn lại', 'Link Hồ sơ']];

                const sortedGroups = Array.from(executionGroups.entries()).sort((a, b) => {
                    const dateA = a[1][Object.keys(a[1])[0]][0].ngayThucHien || '';
                    const dateB = b[1][Object.keys(b[1])[0]][0].ngayThucHien || '';
                    return dateB.localeCompare(dateA);
                });

                let counter = 1;
                for (const [timestampKey, group] of sortedGroups) {
                    for (const childPath in group) {
                        const childName = (docDataMap.get(childPath) || { noiDung: 'N/A' }).noiDung;
                        for (const exec of group[childPath]) {
                             const leafNodeData = docDataMap.get(exec.parentLeafNodePath) || { tt: 'N/A', noiDung: 'N/A', keHoachConLai: '' };
                             rows.push([
                                 counter++,
                                 exec.ngayThucHien,
                                 childName,
                                 leafNodeData.tt,
                                 leafNodeData.noiDung,
                                 exec.dvt,
                                 exec.donGia,
                                 exec.thanhTien,
                                 leafNodeData.keHoachConLai,
                                 exec.hoSoLink || ''
                            ]);
                        }
                    }
                }
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.aoa_to_sheet(rows);
                ws['!cols'] = [ { wch: 5 }, { wch: 15 }, { wch: 40 }, { wch: 8 }, { wch: 60 }, { wch: 12 }, { wch: 15 }, { wch: 15 }, { wch: 15 }, { wch: 40 } ];
                XLSX.utils.book_append_sheet(wb, ws, 'Lịch sử thực hiện');
                XLSX.writeFile(wb, `LichSuThucHien_ToanBo_${currentYear}.xlsx`);
                statusDiv.innerText = "Xuất file Excel thành công!";
            } catch (error) {
                console.error("Lỗi khi xuất toàn bộ lịch sử:", error);
                statusDiv.className = 'error'; statusDiv.innerText = `Lỗi khi xuất Excel: ${error.message}`;
            }
        };
        window.openExecutionEditModal = async (timestampKey) => {
            const groupObject = executionGroups.get(timestampKey);
            if (!groupObject) return;
            const group = Object.values(groupObject).flat();
            const keyParam = typeof timestampKey === 'number' ? timestampKey : `'${timestampKey}'`;
            document.getElementById('modalTitle').innerHTML = `<h2>Sửa lần thực hiện ngày ${group[0].ngayThucHien}</h2>`;
            const headers = [
                { text: 'Mục', width: '4%' }, { text: 'Lĩnh vực', width: '25%' },
                { text: 'Tiểu mục', width: '4%' }, { text: 'Công việc chi tiết', width: '35%' },
                { text: 'Số lượng', width: '6%' }, { text: 'Đơn giá', width: '13%' }, { text: 'Thành tiền', width: '13%' }
            ];
            let table = createModalTable(headers);
            for (const execution of group) {
                const childSnap = await getDoc(doc(db, execution.parentChildPath));
                const leafNodeSnap = await getDoc(doc(db, execution.parentLeafNodePath));
                const childData = childSnap.exists() ? childSnap.data() : { tt: 'N/A', noiDung: 'Không tìm thấy' };
                const leafNodeData = leafNodeSnap.exists() ? leafNodeSnap.data() : { tt: 'N/A', noiDung: 'Không tìm thấy' };
                table += `<tr data-exec-path="${execution.path}" data-tt="${leafNodeData.tt}">
                            <td><input type="text" value="${childData.tt}" disabled></td>
                            <td><input type="text" value="${childData.noiDung}" disabled></td>
                            <td><input type="text" value="${leafNodeData.tt}" disabled></td>
                            <td><input type="text" value="${leafNodeData.noiDung}" disabled></td>
                            <td><input type="number" data-field="dvt" value="${execution.dvt}" oninput="calculateThanhTien(this)"></td>
                            <td><input type="number" data-field="donGia" value="${execution.donGia}" oninput="calculateThanhTien(this)"></td>
                            <td><input type="text" data-field="thanhTien" value="${formatNumber(execution.thanhTien)}" disabled></td>
                         </tr>`;
            }
            table += '</tbody></table>';
            const modalBodyFooter = `<div class="modal-note">Mẹo: Sử dụng phím Enter hoặc các phím mũi tên (↑, ↓) để di chuyển nhanh giữa các ô nhập liệu.</div>`;
            document.getElementById('modalBody').innerHTML = table + modalBodyFooter;
            const footerLeftHTML = `<div style="display: flex; flex-direction: column; align-items: flex-start;">
                                        <div style="display: flex; gap: 10px;">
                                            <button class="btn-success" onclick="exportSingleExecutionToExcel(${keyParam})">Xuất Excel</button>
                                            <button class="btn-warning" onclick="document.getElementById('importExecEditsFile').click()">Nhập từ Excel</button>
                                            <input type="file" id="importExecEditsFile" onchange="importExecutionEdits(event)" style="display: none;" accept=".xlsx, .xls">
                                        </div>
                                        <small style="margin-top: 5px;"><i>Ghi chú: Số liệu trong file excel nhập vào phải có định dạng general.</i></small>
                                    </div>`;
            document.getElementById('modal-footer-left').innerHTML = footerLeftHTML;
            document.getElementById('modalSaveButton').style.display = 'block';
            document.getElementById('modalSaveButton').onclick = () => saveExecutionEdits();
            document.getElementById('modalDeleteButton').style.display = 'block';
            document.getElementById('modalDeleteButton').onclick = () => handleDeleteExecution(timestampKey);
            document.getElementById('dataModal').style.display = 'block';
            setupInputNavigation('#dataModal .modal-table');
        };
        window.importExecutionEdits = (event) => {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const workbook = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
                    const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                    jsonData.forEach(excelRow => {
                        const tt = String(excelRow['Tiểu mục'] || '').trim();
                        if (!tt) return;
                        const modalRow = document.querySelector(`#dataModal .modal-table tbody tr[data-tt="${tt}"]`);
                        if (modalRow) {
                            const soLuongInput = modalRow.querySelector('input[data-field="dvt"]');
                            const donGiaInput = modalRow.querySelector('input[data-field="donGia"]');
                            if (excelRow['Số lượng'] !== undefined) soLuongInput.value = excelRow['Số lượng'];
                            if (excelRow['Đơn giá'] !== undefined) donGiaInput.value = excelRow['Đơn giá'];
                            calculateThanhTien(soLuongInput);
                        }
                    });
                    statusDiv.className = 'success'; statusDiv.innerText = `Đã nhập dữ liệu từ file Excel vào biểu mẫu.`;
                } catch (error) {
                    console.error("Lỗi khi nhập Excel:", error);
                    statusDiv.className = 'error'; statusDiv.innerText = `Lỗi đọc file Excel: ${error.message}`;
                } finally {
                    event.target.value = '';
                }
            };
            reader.readAsArrayBuffer(file);
        };
        window.exportSingleExecutionToExcel = async (timestampKey) => {
            try {
                const groupObject = executionGroups.get(timestampKey);
                if (!groupObject) throw new Error("Không tìm thấy dữ liệu thực hiện.");
                const group = Object.values(groupObject).flat();
                const ngayThucHien = group[0]?.ngayThucHien || 'UnknownDate';
                const headers = ['Mục', 'Lĩnh vực', 'Tiểu mục', 'Công việc chi tiết', 'Số lượng', 'Đơn giá', 'Thành tiền'];
                const rows = [headers];
                for (const exec of group) {
                    const childSnap = await getDoc(doc(db, exec.parentChildPath));
                    const leafNodeSnap = await getDoc(doc(db, exec.parentLeafNodePath));
                    const childData = childSnap.exists() ? childSnap.data() : { tt: 'N/A', noiDung: 'N/A' };
                    const leafNodeData = leafNodeSnap.exists() ? leafNodeSnap.data() : { tt: 'N/A', noiDung: 'N/A' };
                    rows.push([ childData.tt, childData.noiDung, leafNodeData.tt, leafNodeData.noiDung, exec.dvt, exec.donGia, exec.thanhTien ]);
                }
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.aoa_to_sheet(rows);
                ws['!cols'] = [{ wch: 8 }, { wch: 40 }, { wch: 8 }, { wch: 60 }, { wch: 12 }, { wch: 15 }, { wch: 15 }];
                XLSX.utils.book_append_sheet(wb, ws, 'Chi tiết thực hiện');
                XLSX.writeFile(wb, `ChiTietThucHien_${ngayThucHien}_${currentYear}.xlsx`);
                statusDiv.className = 'success';
                statusDiv.innerText = "Xuất Excel thành công.";
            } catch (error) {
                console.error("Lỗi khi xuất Excel:", error);
                statusDiv.className = 'error';
                statusDiv.innerText = `Lỗi khi xuất Excel: ${error.message}`;
                throw error;
            }
        };
        window.handleProfileUploadClick = async (timestampKey) => {
            if (!gapiReady) { alert("Dịch vụ Google chưa sẵn sàng, vui lòng thử lại sau giây lát."); return; }
            try {
                await ensureGapiAuthenticated();
                const uploadModal = document.getElementById('uploadPdfModal');
                const uploadButton = document.getElementById('uploadPdfButton');
                document.getElementById('pdf_file_input').value = '';
                uploadModal.style.display = 'block';
                uploadButton.onclick = () => performPdfUpload(timestampKey);
            } catch(error) {
                console.error("Lỗi xác thực Google:", error);
                statusDiv.className = 'error';
                statusDiv.innerText = 'Lỗi xác thực với Google. Vui lòng thử lại.';
            }
        };
        window.toggleSelection = (checkbox) => {
            const path = checkbox.dataset.path;
            const isJustification = checkbox.classList.contains('justification-checkbox');

            if (checkbox.checked) {
                if(isJustification) selectedJustifications.add(path);
                else selectedTasks.add(path);
            } else {
                if(isJustification) selectedJustifications.delete(path);
                else selectedTasks.delete(path);
            }
            updateButtonStates();
            if (checkbox.dataset.parentPath) {
                updateParentCheckboxState(checkbox.dataset.parentPath);
            }
        };
        window.toggleChildrenCheckboxes = (parentCheckbox) => {
            const parentPath = parentCheckbox.dataset.path;
            const isChecked = parentCheckbox.checked;
            parentCheckbox.indeterminate = false;

            const descendants = document.querySelectorAll(`input[data-parent-path^="${parentPath}"]`);
            descendants.forEach(checkbox => {
                if (checkbox.checked !== isChecked) {
                    checkbox.checked = isChecked;
                    checkbox.dispatchEvent(new Event('change'));
                }
            });
            if (parentCheckbox.dataset.parentPath) {
                 updateParentCheckboxState(parentCheckbox.dataset.parentPath);
            }
        };
        const updateParentCheckboxState = (parentPath) => {
            if (!parentPath) return;
            const parentCheckbox = document.querySelector(`input.parent-checkbox[data-path="${parentPath}"]`);
            if (!parentCheckbox) return;

            const childrenCheckboxes = document.querySelectorAll(`input[data-parent-path="${parentPath}"]`);
            if(childrenCheckboxes.length === 0) return;

            let checkedCount = 0;
            let indeterminateCount = 0;
            childrenCheckboxes.forEach(cb => {
                if (cb.checked) checkedCount++;
                if (cb.indeterminate) indeterminateCount++;
            });

            if (indeterminateCount > 0 || (checkedCount > 0 && checkedCount < childrenCheckboxes.length)) {
                parentCheckbox.checked = false;
                parentCheckbox.indeterminate = true;
            } else if (checkedCount === childrenCheckboxes.length) {
                parentCheckbox.checked = true;
                parentCheckbox.indeterminate = false;
            } else {
                parentCheckbox.checked = false;
                parentCheckbox.indeterminate = false;
            }

            if (parentCheckbox.dataset.parentPath) {
                updateParentCheckboxState(parentCheckbox.dataset.parentPath);
            }
        };
        window.toggleAllCheckboxes = (masterCheckbox) => {
            const isChecked = masterCheckbox.checked;
            document.querySelectorAll('.parent-checkbox, .task-checkbox, .justification-checkbox').forEach(cb => {
                cb.indeterminate = false;
                if (cb.checked !== isChecked) {
                    cb.checked = isChecked;
                    cb.dispatchEvent(new Event('change'));
                }
            });
        };

        window.exportToExcel = (type) => {
            activeExportType = (type === 1) ? 'simplified' : 'full';
            document.getElementById('exportOptionsModal').style.display = 'block';
        };

        async function getExportData(exportType) {
            statusDiv.className = 'success';
            statusDiv.innerText = 'Đang chuẩn bị dữ liệu. Vui lòng chờ...';

            const executionsMap = new Map();
            let maxExecutions = 0;

            if (exportType !== 'full') {
                const execQuery = query(collectionGroup(db, 'thực hiện'));
                const execSnapshot = await getDocs(execQuery);
                execSnapshot.forEach(docSnap => {
                    if (docSnap.ref.path.includes(getParentCollectionName())) {
                        const data = docSnap.data();
                        const parentLeafPath = docSnap.ref.parent.parent.path;
                        if (!executionsMap.has(parentLeafPath)) executionsMap.set(parentLeafPath, []);
                        executionsMap.get(parentLeafPath).push(data);
                        maxExecutions = Math.max(maxExecutions, executionsMap.get(parentLeafPath).length);
                    }
                });
            }
            
            let baseHeaders;
            if (exportType === 'simplified') {
                baseHeaders = ['TT', 'Đầu việc/ Dự án', 'ĐV th.hiện', 'Đ.vị tính', 'Số lượng', 'Tần suất TH', 'Chi phí', 'Chi phí thực hiện', 'Kế hoạch còn lại', 'Cấp độ'];
            } else {
                baseHeaders = ['TT', 'Đầu việc/ Dự án', 'ĐV th.hiện', 'Đ.vị tính', 'Số lượng', 'Tần suất TH', 'CP giải trình', 'Chi phí', 'Chi phí thực hiện', 'Kế hoạch còn lại', 'Cấp độ', 'KH năm trước', 'Ghi chú'];
            }

            let executionHeaders = [];
            if (exportType !== 'full') {
                executionHeaders = Array.from({ length: maxExecutions }, (_, i) => [`Ngày TH (${i+1})`, `Số lượng (${i+1})`, `Đơn giá (${i+1})`, `Thành tiền (${i+1})`, `Timestamp (${i+1})`, `Hồ sơ Link (${i+1})`]).flat();
            }

            const rows = [];
            const boldRows = new Set();
            const italicRows = new Set();
            const rightAlignTTRows = new Set();
            const parentSnapshot = await getDocs(query(collection(db, getParentCollectionName())));
            const parents = parentSnapshot.docs.map(d => ({id: d.id, ...d.data()})).sort((a, b) => a.id.localeCompare(b.id));

            for (const parentData of parents) {
                boldRows.add(rows.length); rows.push([ parentData.tt, parentData.noiDung, ...Array(baseHeaders.length - 2).fill('') ]);
                const children = (await getDocs(query(collection(db, `${getParentCollectionName()}/${parentData.id}/công việc con`)))).docs.map(d => ({id: d.id, ...d.data()})).sort(childSort);
                for (const childData of children) {
                    boldRows.add(rows.length); rows.push([ childData.tt, childData.noiDung, ...Array(baseHeaders.length - 2).fill('') ]);
                    const grandchildren = (await getDocs(query(collection(db, `${getParentCollectionName()}/${parentData.id}/công việc con/${childData.id}/công việc cháu`)))).docs.map(d => ({id: d.id, ...d.data()})).sort((a,b) => parseInt(a.id, 10) - parseInt(b.id, 10));
                    for (const grandchildData of grandchildren) {
                         boldRows.add(rows.length); rows.push([ grandchildData.tt, grandchildData.noiDung, ...Array(baseHeaders.length - 2).fill('') ]);
                         const greatGrandchildren = (await getDocs(query(collection(db, `${getParentCollectionName()}/${parentData.id}/công việc con/${childData.id}/công việc cháu/${grandchildData.id}/công việc chắt`)))).docs.map(d => ({id: d.id, path: d.ref.path, ...d.data()})).sort(numericSort);
                         for (const ggcData of greatGrandchildren) {
                            let rowData;
                            if (exportType === 'simplified') {
                                rowData = [ ggcData.tt, ggcData.noiDung, ggcData.dvThucHien, ggcData.donVi, ggcData.soLuong, ggcData.tanSuatTH, ggcData.chiPhi, ggcData.chiPhiThucHien, ggcData.keHoachConLai, ggcData.capDo ];
                            } else {
                                rowData = [ ggcData.tt, ggcData.noiDung, ggcData.dvThucHien, ggcData.donVi, ggcData.soLuong, ggcData.tanSuatTH, ggcData.cpGiaiTrinh, ggcData.chiPhi, ggcData.chiPhiThucHien, ggcData.keHoachConLai, ggcData.capDo, ggcData.khNamTruoc, ggcData.ghiChu || '' ];
                            }
                            
                            if (!ggcData.hasChildren && exportType !== 'full') {
                                const executions = executionsMap.get(ggcData.path) || [];
                                executions.forEach(exec => {
                                    const execTimestamp = exec.timestamp?.toMillis ? new Date(exec.timestamp.toMillis()).toLocaleString('vi-VN') : (exec.timestamp || '');
                                    rowData.push(exec.ngayThucHien, exec.dvt, exec.donGia, exec.thanhTien, execTimestamp, exec.hoSoLink || '');
                                });
                            }
                            rows.push(rowData);

                            if (exportType !== 'simplified') {
                                const justifications1 = (await getDocs(query(collection(db, ggcData.path, "giải trình")))).docs.map(d => d.data()).sort((a,b) => a.tt.localeCompare(b.tt));
                                for(const justData of justifications1) {
                                    italicRows.add(rows.length);
                                    rightAlignTTRows.add(rows.length);
                                    rows.push([ justData.tt, `    ${justData.noiDung}`, '', justData.donVi, justData.soLuong, '', justData.cpGiaiTrinh, ...Array(6).fill('') ]);
                                }
                            }

                            if(ggcData.hasChildren) {
                                boldRows.add(rows.length - 1 - (exportType !== 'simplified' ? (await getDocs(query(collection(db, ggcData.path, "giải trình")))).size : 0));
                                const greatGreatGrandchildren = (await getDocs(query(collection(db, `${ggcData.path}/công việc cụ thể`)))).docs.map(d => ({id: d.id, path: d.ref.path, ...d.data()})).sort(numericSort);
                                for (const gggcData of greatGreatGrandchildren) {
                                    let gggcRowData;
                                    if(exportType === 'simplified') {
                                        gggcRowData = [ gggcData.tt, gggcData.noiDung, gggcData.dvThucHien, gggcData.donVi, gggcData.soLuong, gggcData.tanSuatTH, gggcData.chiPhi, gggcData.chiPhiThucHien, gggcData.keHoachConLai, gggcData.capDo ];
                                    } else {
                                        gggcRowData = [ gggcData.tt, gggcData.noiDung, gggcData.dvThucHien, gggcData.donVi, gggcData.soLuong, gggcData.tanSuatTH, gggcData.cpGiaiTrinh, gggcData.chiPhi, gggcData.chiPhiThucHien, gggcData.keHoachConLai, gggcData.capDo, gggcData.khNamTruoc, gggcData.ghiChu || '' ];
                                    }

                                    if(exportType !== 'full') {
                                        const executions = executionsMap.get(gggcData.path) || [];
                                        executions.forEach(exec => {
                                            const execTimestamp = exec.timestamp?.toMillis ? new Date(exec.timestamp.toMillis()).toLocaleString('vi-VN') : (exec.timestamp || '');
                                            gggcRowData.push(exec.ngayThucHien, exec.dvt, exec.donGia, exec.thanhTien, execTimestamp, exec.hoSoLink || '');
                                        });
                                    }
                                    rows.push(gggcRowData);
                                    
                                    if (exportType !== 'simplified') {
                                        const justifications2 = (await getDocs(query(collection(db, gggcData.path, "giải trình")))).docs.map(d => d.data()).sort((a,b) => a.tt.localeCompare(b.tt));
                                        for(const justData of justifications2) {
                                            italicRows.add(rows.length);
                                            rightAlignTTRows.add(rows.length);
                                            rows.push([ justData.tt, `    ${justData.noiDung}`, '', justData.donVi, justData.soLuong, '', justData.cpGiaiTrinh, ...Array(6).fill('') ]);
                                        }
                                    }
                                }
                            }
                         }
                    }
                }
            }
            return { fullHeaders: [...baseHeaders, ...executionHeaders], rows, boldRows, italicRows, rightAlignTTRows, maxExecutions };
        }

        window.exportPlainDataExcel = async () => {
            try {
                closeAllModals();
                const { fullHeaders, rows, boldRows, maxExecutions } = await getExportData(activeExportType);

                statusDiv.innerText = 'Đang ghi dữ liệu ra file, vui lòng chờ trong giây lát...';
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.aoa_to_sheet([fullHeaders, ...rows]);
                for (let i = 0; i < rows.length; i++) {
                    if (boldRows.has(i)) {
                        for (let j = 0; j < 2; j++) {
                            const cellAddress = XLSX.utils.encode_cell({ r: i + 1, c: j });
                            if(ws[cellAddress]) {
                                if(!ws[cellAddress].s) ws[cellAddress].s = {};
                                if(!ws[cellAddress].s.font) ws[cellAddress].s.font = {};
                                ws[cellAddress].s.font.bold = true;
                            }
                        }
                    }
                }
                let colWidths;
                if(activeExportType === 'simplified') {
                     colWidths = [ { wch: 8 }, { wch: 40 }, { wch: 12 }, { wch: 10 }, { wch: 10 }, { wch: 12 }, { wch: 15 }, { wch: 15 }, { wch: 15 }, { wch: 10 } ];
                } else {
                     colWidths = [ { wch: 8 }, { wch: 40 }, { wch: 12 }, { wch: 10 }, { wch: 10 }, { wch: 12 }, { wch: 15 }, { wch: 15 }, { wch: 15 }, { wch: 15 }, { wch: 10 }, { wch: 15 }, {wch: 25} ];
                }
                
                if(activeExportType !== 'full') {
                    for (let i = 0; i < maxExecutions; i++) {
                        colWidths.push({ wch: 12 }, { wch: 12 }, { wch: 15 }, { wch: 15 }, { wch: 22 }, { wch: 40 });
                    }
                }

                ws['!cols'] = colWidths;
                XLSX.utils.book_append_sheet(wb, ws, 'Danh sách công việc');
                XLSX.writeFile(wb, `atclmt_${activeExportType === 'simplified' ? 'RutGon' : 'DayDu'}_${currentYear}.xlsx`);
                statusDiv.innerText = 'Xuất file Excel thành công!';
            } catch (error) {
                console.error("Lỗi khi xuất Excel: ", error);
                statusDiv.className = 'error'; statusDiv.innerText = `Lỗi khi xuất file: ${error.message}`;
            }
        };

        window.exportFormattedExcel_HTML = async () => {
             try {
                closeAllModals();
                const { fullHeaders, rows, boldRows, italicRows, rightAlignTTRows } = await getExportData(activeExportType);

                statusDiv.innerText = 'Đang tạo bảng HTML để xuất...';

                let tableHtml = `<table border="1"><thead><tr>${fullHeaders.map(h => `<th>${h}</th>`).join('')}</tr></thead><tbody>`;

                for (let i = 0; i < rows.length; i++) {
                    const row = rows[i];
                    const isBold = boldRows.has(i);
                    const isItalic = italicRows.has(i);

                    tableHtml += '<tr>';
                    row.forEach((cell, j) => {
                        let styles = [];
                        const isRightAlignTT = rightAlignTTRows.has(i) && j === 0;
                        if (isBold) styles.push('font-weight: bold;');
                        if (isItalic) styles.push('font-style: italic;');
                        if (isRightAlignTT) styles.push('text-align: right;');

                        let timestampColumnIndex = -1;
                        if(activeExportType === 'simplified') timestampColumnIndex = 10;
                        
                        if (timestampColumnIndex !== -1 && j >= timestampColumnIndex && (j - timestampColumnIndex) % 6 === 0) styles.push("mso-number-format:'\\@'");
                        
                        const styleAttr = styles.length > 0 ? ` style="${styles.join(' ')}"` : '';
                        const cellData = cell === null || cell === undefined ? '' : cell;
                        tableHtml += `<td${styleAttr}>${cellData}</td>`;
                    });
                    tableHtml += '</tr>';
                }
                tableHtml += '</tbody></table>';

                const excelTemplate = `<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40"><head><meta charset="UTF-8"></head><body>${tableHtml}</body></html>`;

                const blob = new Blob([excelTemplate], { type: 'application/vnd.ms-excel' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `atclmt_${activeExportType === 'simplified' ? 'RutGon_DinhDang' : 'DayDu_DinhDang'}_${currentYear}.xls`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(link.href);

                statusDiv.innerText = 'Xuất file Excel định dạng thành công!';
            } catch (error) {
                console.error("Lỗi khi xuất Excel định dạng:", error);
                statusDiv.className = 'error'; statusDiv.innerText = `Lỗi khi xuất file: ${error.message}`;
            }
        };


        const scrollToTopBtn = document.getElementById("scrollToTopBtn");
        window.onscroll = () => {
            if (document.body.scrollTop > 100 || document.documentElement.scrollTop > 100) {
                scrollToTopBtn.style.display = "block";
            } else {
                scrollToTopBtn.style.display = "none";
            }
        };
        scrollToTopBtn.onclick = () => { window.scrollTo({top: 0, behavior: 'smooth'}); };

        async function startApp() {
            const settingsDocRef = doc(db, 'settings', 'global');
            onSnapshot(settingsDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    editModeStatusByYear = docSnap.data().editModeStatus || {};
                } else {
                    editModeStatusByYear = {};
                }
                updateButtonStates();
            });

            initializeYearDropdown();
            initializeGoogleClients();
            togglePlanningColumns(false);
        }

        startApp();
    </script>
</body>
</html>
